<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSF - Osrodek Sprawnosci Fizycznej</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef1f5; padding: 20px; color: #2d3748; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 16px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%); color: white; padding: 24px; text-align: center; }
        .header h1 { font-size: 22px; font-weight: 700; letter-spacing: 1px; }
        .header p { font-size: 13px; opacity: 0.8; margin-top: 4px; }
        .nav { display: flex; background: #f7f8fa; border-bottom: 2px solid #e2e8f0; }
        .nav-btn { flex: 1; padding: 14px 8px; background: #f7f8fa; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: #64748b; transition: all 0.2s; }
        .nav-btn:hover { background: #edf2f7; color: #2d3748; }
        .nav-btn.active { background: white; border-bottom: 3px solid #3182ce; color: #3182ce; font-weight: 600; }
        .content { padding: 24px; min-height: 500px; }
        .section { display: none; }
        .section.active { display: block; }
        input, select, button, textarea { padding: 10px 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; font-family: inherit; }
        input:focus, select:focus { outline: none; border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49,130,206,0.1); }
        button { background: #3182ce; color: white; border: none; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        button:hover { background: #2c5282; }
        .btn-success { background: #38a169; }
        .btn-success:hover { background: #2f855a; }
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        .btn-warning { background: #d69e2e; color: #fff; }
        .btn-warning:hover { background: #b7791f; }
        .btn-secondary { background: #718096; }
        .btn-secondary:hover { background: #4a5568; }
        .btn-live { background: #805ad5; }
        .btn-live:hover { background: #6b46c1; }
        table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        th, td { border: 1px solid #e2e8f0; padding: 10px 8px; text-align: left; }
        th { background: #f7fafc; font-weight: 600; color: #4a5568; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .pk-row { background: #fffff0; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .card h3 { color: #2d3748; font-size: 16px; margin-bottom: 12px; }
        .text-center { text-align: center; }
        .text-success { color: #38a169; }
        .text-danger { color: #e53e3e; }
        .text-warning { color: #d69e2e; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
        .lane-selector { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        .time-input { width: 80px; }
        .status-select { width: 70px; }
        h2 { color: #2d3748; font-size: 20px; margin-bottom: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .section-subtitle { color: #718096; font-size: 14px; margin-bottom: 16px; }
        .results-nav { display: flex; gap: 8px; margin-bottom: 20px; }
        .results-nav .nav-btn { flex: none; padding: 8px 20px; border-radius: 20px; font-size: 13px; background: #edf2f7; color: #4a5568; }
        .results-nav .nav-btn.active { background: #3182ce; color: white; }
        .results-nav .nav-btn:hover:not(.active) { background: #e2e8f0; }
        .gender-section { margin-bottom: 24px; }
        .gender-section h4 { padding: 10px 16px; border-radius: 8px 8px 0 0; margin-bottom: 0; font-size: 15px; }
        .gender-section-male h4 { background: #ebf4ff; color: #2b6cb0; border-left: 4px solid #3182ce; }
        .gender-section-female h4 { background: #fff5f5; color: #c53030; border-left: 4px solid #e53e3e; }
        @media print { .nav, button:not(.print-only) { display: none !important; } .container { box-shadow: none; } .content { padding: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OSF - Osrodek Sprawnosci Fizycznej</h1>
            <p>System zarzadzania zawodami sportowymi</p>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('units')">Jednostki</button>
            <button class="nav-btn" onclick="showSection('competitors')">Zawodnicy</button>
            <button class="nav-btn" onclick="showSection('schema')">Schemat</button>
            <button class="nav-btn" onclick="showSection('series1')">I Seria</button>
            <button class="nav-btn" onclick="showSection('series2')">II Seria</button>
            <button class="nav-btn" onclick="showSection('results')">Wyniki</button>
        </div>

        <div class="content">
            <div class="card">
                <h3>Informacje o zawodach</h3>
                <div class="flex">
                    <input type="text" id="eventName" placeholder="Nazwa zawodow" style="flex: 1;">
                    <input type="text" id="eventLocation" placeholder="Miejscowosc" style="flex: 1;">
                </div>
                <div class="flex mt-20">
                    <button onclick="saveAllData()" class="btn-success">Zapisz dane</button>
                    <button onclick="loadAllData()" class="btn-secondary">Wczytaj dane</button>
                    <button onclick="clearAllData()" class="btn-danger">Wyczysc wszystko</button>
                    <span id="saveStatus" style="color: #38a169; font-size: 12px;"></span>
                </div>
            </div>

            <!-- Jednostki -->
            <div id="units" class="section active">
                <h2>Zarzadzanie Jednostkami</h2>
                <div class="card">
                    <h3>Dodaj Jednostke</h3>
                    <div class="flex">
                        <input type="text" id="unitName" placeholder="Nazwa jednostki" style="flex: 1;">
                        <input type="number" id="unitNumber" placeholder="Numer" min="1" max="10">
                        <button onclick="addUnit()" class="btn-success">Dodaj</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Import druzyn i zawodnikow z CSV</h3>
                    <p style="font-size: 12px; color: #718096; margin-bottom: 4px;">Format: <code>nr_druzyny;nazwa_druzyny;nr_zawodnika;imie;nazwisko;plec;stopien</code></p>
                    <p style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">stopien - opcjonalny | plec: M lub K | separator: srednik lub przecinek</p>
                    <div class="flex">
                        <input type="file" id="csvFileInput" accept=".csv,.txt" style="flex:1;">
                        <button onclick="importCSV()" class="btn-success">Importuj CSV</button>
                        <button onclick="downloadDemoCSV('zawodnicy')" class="btn-secondary" style="font-size: 12px;">Pobierz demo</button>
                    </div>
                    <div id="csvImportStatus" style="margin-top: 8px; font-size: 12px;"></div>
                </div>
                <div class="card" style="background: #f7fafc; border: 1px dashed #cbd5e0;">
                    <h3 style="cursor: pointer;" onclick="toggleInstructions()">Instrukcja importu CSV <span id="instrToggle" style="font-size: 12px; color: #718096;">(kliknij aby rozwinac)</span></h3>
                    <div id="instructionsPanel" style="display: none; margin-top: 12px; font-size: 13px; line-height: 1.6; color: #4a5568;">
                        <h4 style="margin-bottom: 8px;">1. Plik zawodnikow (druzyny + zawodnicy)</h4>
                        <p>Kazdy wiersz = jeden zawodnik. Druzyny tworza sie automatycznie.</p>
                        <table style="font-size: 12px; margin: 8px 0;">
                            <thead><tr><th>Kolumna</th><th>Opis</th><th>Wymagana</th><th>Przyklad</th></tr></thead>
                            <tbody>
                                <tr><td>nr_druzyny</td><td>Numer druzyny (tor)</td><td>TAK</td><td>1</td></tr>
                                <tr><td>nazwa_druzyny</td><td>Nazwa jednostki</td><td>TAK</td><td>OSP Powidz</td></tr>
                                <tr><td>nr_zawodnika</td><td>Pozycja zawodnika w druzynie</td><td>TAK</td><td>3</td></tr>
                                <tr><td>imie</td><td>Imie</td><td>TAK</td><td>Jan</td></tr>
                                <tr><td>nazwisko</td><td>Nazwisko</td><td>TAK</td><td>Kowalski</td></tr>
                                <tr><td>plec</td><td>M lub K</td><td>TAK</td><td>M</td></tr>
                                <tr><td>stopien</td><td>Stopien sluzbowy</td><td>NIE</td><td>mł. ogn.</td></tr>
                            </tbody>
                        </table>
                        <p><strong>Przyklad wiersza:</strong> <code>1;OSP Powidz;3;Jan;Kowalski;M;mł. ogn.</code></p>

                        <h4 style="margin: 16px 0 8px;">2. Plik schematu biegow</h4>
                        <p>Kazdy wiersz = jeden bieg. Podajesz numer druzyny i numer zawodnika dla lewego i prawego toru.</p>
                        <table style="font-size: 12px; margin: 8px 0;">
                            <thead><tr><th>Kolumna</th><th>Opis</th><th>Przyklad</th></tr></thead>
                            <tbody>
                                <tr><td>lewy_druzyna</td><td>Nr druzyny - tor lewy</td><td>1</td></tr>
                                <tr><td>lewy_zawodnik</td><td>Nr zawodnika - tor lewy</td><td>1</td></tr>
                                <tr><td>prawy_druzyna</td><td>Nr druzyny - tor prawy</td><td>2</td></tr>
                                <tr><td>prawy_zawodnik</td><td>Nr zawodnika - tor prawy</td><td>1</td></tr>
                            </tbody>
                        </table>
                        <p><strong>Przyklad wiersza:</strong> <code>1;1;2;1</code> (druzyna 1 zaw. 1 vs druzyna 2 zaw. 1)</p>
                        <p style="margin-top: 4px;">Mozna tez wpisac puste pole jesli bieg jest pojedynczy: <code>1;3;;</code></p>
                    </div>
                </div>
                <div class="card">
                    <h3>Lista Jednostek</h3>
                    <table>
                        <thead>
                            <tr><th>Nazwa</th><th>Numer</th><th>Zawodnicy</th><th>Akcje</th></tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <tr><td colspan="4" class="text-center">Brak jednostek</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Zawodnicy -->
            <div id="competitors" class="section">
                <h2>Zarzadzanie Zawodnikami</h2>
                <div class="card">
                    <h3>Dodaj Zawodnika</h3>
                    <div class="grid">
                        <input type="text" id="competitorFirstName" placeholder="Imie">
                        <input type="text" id="competitorLastName" placeholder="Nazwisko">
                        <select id="competitorUnit">
                            <option value="">Wybierz jednostke</option>
                        </select>
                        <select id="competitorGender">
                            <option value="M">Mezczyzna</option>
                            <option value="K">Kobieta</option>
                        </select>
                    </div>
                    <div class="flex mt-20">
                        <label><input type="checkbox" id="competitorPK"> PK (Poza Konkurencja)</label>
                        <button onclick="addCompetitor()" class="btn-success">Dodaj Zawodnika</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Lista Zawodnikow</h3>
                    <div id="competitorsList"></div>
                </div>
            </div>

            <!-- Schemat -->
            <div id="schema" class="section">
                <h2>Schemat Biegow - I Seria</h2>
                <div class="card">
                    <div class="flex" style="flex-wrap: wrap;">
                        <button onclick="generateAutoSchema()" class="btn-success">Generuj Automatycznie</button>
                        <button onclick="addManualRace()">Dodaj Bieg Recznie</button>
                        <button onclick="clearSchema()" class="btn-danger">Wyczysc</button>
                        <button onclick="printSection('schema')" class="btn-warning">Drukuj</button>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h4 style="margin-bottom: 8px; color: #4a5568; font-size: 14px;">Import schematu z CSV</h4>
                        <p style="font-size: 12px; color: #718096; margin-bottom: 8px;">Format: <code>lewy_druzyna;lewy_zawodnik;prawy_druzyna;prawy_zawodnik</code> (puste = brak na torze)</p>
                        <div class="flex">
                            <input type="file" id="csvSchemaInput" accept=".csv,.txt" style="flex:1;">
                            <button onclick="importSchemaCSV()" class="btn-success">Importuj schemat</button>
                            <button onclick="downloadDemoCSV('schemat')" class="btn-secondary" style="font-size: 12px;">Pobierz demo</button>
                        </div>
                        <div id="schemaImportStatus" style="margin-top: 8px; font-size: 12px;"></div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h4 style="margin-bottom: 10px; color: #4a5568;">Szybkie Dodawanie Biegu</h4>
                        <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                            <div>
                                <label style="font-size: 12px; color: #718096;">Lewy - Jednostka:</label>
                                <select id="quickLeftUnit" style="width: 100%;">
                                    <option value="">-</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #718096;">Pozycja:</label>
                                <select id="quickLeftPos" style="width: 100%;">
                                    <option value="">-</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #718096;">Prawy - Jednostka:</label>
                                <select id="quickRightUnit" style="width: 100%;">
                                    <option value="">-</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #718096;">Pozycja:</label>
                                <select id="quickRightPos" style="width: 100%;">
                                    <option value="">-</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex" style="margin-top: 15px;">
                            <span id="quickPreview" style="flex: 1; font-style: italic; color: #718096;"></span>
                            <button onclick="addQuickRace()" class="btn-success">Dodaj Bieg</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Lista Biegow</h3>
                    <div id="schemaList"></div>
                    <button id="startSeries1Btn" onclick="startSeries1()" class="btn-success" style="display:none; margin-top: 20px;">
                        Rozpocznij I Serie
                    </button>
                </div>
            </div>

            <!-- I Seria -->
            <div id="series1" class="section">
                <h2>I Seria - Wprowadzanie Wynikow</h2>
                <div class="card">
                    <div class="flex mb-20">
                        <button onclick="printSection('series1')" class="btn-warning">Drukuj</button>
                        <button onclick="openLiveResults()" class="btn-live">Wyniki na zywo (drugi ekran)</button>
                    </div>
                    <h3>Lista Startowa I Serii</h3>
                    <div id="series1List"></div>
                    <button id="startSeries2Btn" onclick="startSeries2()" class="btn-success" style="display:none; margin-top: 20px;">
                        Generuj II Serie
                    </button>
                </div>
            </div>

            <!-- II Seria -->
            <div id="series2" class="section">
                <h2>II Seria - Wyniki</h2>
                <div class="card">
                    <div class="flex mb-20">
                        <button onclick="printSection('series2')" class="btn-warning">Drukuj</button>
                        <button onclick="openLiveResults()" class="btn-live">Wyniki na zywo (drugi ekran)</button>
                    </div>
                    <p class="section-subtitle"><strong>Zasada:</strong> Zawodnicy zmieniaja tory (lewy - prawy). Kolejnosc: DDF/DSQ - najgorsze czasy - najlepsze czasy. Oddzielne drabinki dla kobiet i mezczyzn.</p>
                    <div id="series2List"></div>
                    <button id="generateResultsBtn" onclick="generateFinalResults()" class="btn-success" style="display:none; margin-top: 20px;">
                        Generuj Wyniki Koncowe
                    </button>
                </div>
            </div>

            <!-- Wyniki -->
            <div id="results" class="section">
                <h2>Wyniki Koncowe</h2>
                <div class="card">
                    <div class="flex mb-20">
                        <button onclick="printSection('results')" class="btn-warning">Drukuj</button>
                        <button onclick="openLiveResults()" class="btn-live">Wyniki na zywo (drugi ekran)</button>
                    </div>
                    <div class="results-nav">
                        <button onclick="showResults('M')" class="nav-btn active" id="resultsMBtn">Mezczyzni</button>
                        <button onclick="showResults('K')" class="nav-btn" id="resultsKBtn">Kobiety</button>
                    </div>
                    <div id="finalResultsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal edycji -->
    <div id="editRaceModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 16px;">Edytuj Bieg</h3>
            <div class="lane-selector">
                <label>Tor lewy:</label>
                <select id="editLeftUnit"><option value="">Brak</option></select>
                <span>/</span>
                <select id="editLeftPosition"><option value="">-</option></select>
                <span id="editLeftName"></span>
            </div>
            <div class="lane-selector">
                <label>Tor prawy:</label>
                <select id="editRightUnit"><option value="">Brak</option></select>
                <span>/</span>
                <select id="editRightPosition"><option value="">-</option></select>
                <span id="editRightName"></span>
            </div>
            <div class="flex mt-20">
                <button onclick="saveRaceEdit()" class="btn-success">Zapisz</button>
                <button onclick="closeEditModal()" class="btn-secondary">Anuluj</button>
            </div>
        </div>
    </div>

    <script>
        let units = [];
        let competitors = [];
        let schema = [];
        let series1Results = [];
        let series2Results = [];
        let currentResultsView = 'M';
        let editingRaceId = null;
        let liveResultsWindow = null;

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav > .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
        }

        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === '-') return 9999;
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            }
            return 9999;
        }

        function getCompetitorGender(competitorId) {
            const comp = competitors.find(c => c.id === competitorId);
            return comp ? comp.gender : 'M';
        }

        // ==================== UNITS ====================

        function addUnit() {
            const name = document.getElementById('unitName').value.trim();
            const number = document.getElementById('unitNumber').value;

            if (!name) {
                alert('Wprowadz nazwe jednostki');
                return;
            }

            if (number && units.find(u => u.number == number)) {
                alert('Ten numer jest juz zajety');
                return;
            }

            units.push({
                id: Date.now(),
                name: name,
                number: number ? parseInt(number) : null
            });

            document.getElementById('unitName').value = '';
            document.getElementById('unitNumber').value = '';

            updateUnitsTable();
            updateCompetitorUnitSelect();
            updateEditModalsSelects();
        }

        function updateUnitsTable() {
            const tbody = document.getElementById('unitsTableBody');

            if (units.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Brak jednostek</td></tr>';
                return;
            }

            tbody.innerHTML = units.map(unit => {
                const competitorCount = competitors.filter(c => c.unitId === unit.id).length;
                return `
                    <tr>
                        <td>${unit.name}</td>
                        <td>
                            <input type="number" value="${unit.number || ''}"
                                   onchange="updateUnitNumber(${unit.id}, this.value)"
                                   min="1" max="10" style="width: 60px;">
                        </td>
                        <td>${competitorCount}/12</td>
                        <td>
                            <button onclick="deleteUnit(${unit.id})" class="btn-danger">Usun</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateUnitNumber(unitId, number) {
            const unit = units.find(u => u.id === unitId);
            if (unit) {
                if (number && units.find(u => u.id !== unitId && u.number == number)) {
                    alert('Ten numer jest juz zajety');
                    updateUnitsTable();
                    return;
                }
                unit.number = number ? parseInt(number) : null;
                updateEditModalsSelects();
            }
        }

        function deleteUnit(unitId) {
            if (confirm('Czy na pewno usunac jednostke? Zostana usunieci rowniez jej zawodnicy.')) {
                units = units.filter(u => u.id !== unitId);
                competitors = competitors.filter(c => c.unitId !== unitId);
                updateUnitsTable();
                updateCompetitorsList();
                updateCompetitorUnitSelect();
                updateEditModalsSelects();
            }
        }

        function updateCompetitorUnitSelect() {
            const select = document.getElementById('competitorUnit');
            select.innerHTML = '<option value="">Wybierz jednostke</option>';
            units.forEach(unit => {
                select.innerHTML += `<option value="${unit.id}">${unit.name}${unit.number ? ` (${unit.number})` : ''}</option>`;
            });
        }

        // ==================== COMPETITORS ====================

        function addCompetitor() {
            const firstName = document.getElementById('competitorFirstName').value.trim();
            const lastName = document.getElementById('competitorLastName').value.trim();
            const unitId = document.getElementById('competitorUnit').value;
            const gender = document.getElementById('competitorGender').value;
            const isPK = document.getElementById('competitorPK').checked;

            if (!firstName || !lastName || !unitId) {
                alert('Wypelnij wszystkie pola');
                return;
            }

            const unitCompetitors = competitors.filter(c => c.unitId == unitId);

            if (unitCompetitors.length >= 12) {
                alert('Maksymalnie 12 zawodnikow na jednostke');
                return;
            }

            competitors.push({
                id: Date.now(),
                firstName: firstName,
                lastName: lastName,
                unitId: parseInt(unitId),
                gender: gender,
                isPK: isPK,
                position: unitCompetitors.length + 1
            });

            document.getElementById('competitorFirstName').value = '';
            document.getElementById('competitorLastName').value = '';
            document.getElementById('competitorPK').checked = false;

            updateCompetitorsList();
            updateUnitsTable();
        }

        function updateCompetitorsList() {
            const container = document.getElementById('competitorsList');

            if (competitors.length === 0) {
                container.innerHTML = '<p class="text-center">Brak zawodnikow</p>';
                return;
            }

            const competitorsByUnit = {};
            competitors.forEach(competitor => {
                if (!competitorsByUnit[competitor.unitId]) {
                    competitorsByUnit[competitor.unitId] = [];
                }
                competitorsByUnit[competitor.unitId].push(competitor);
            });

            container.innerHTML = Object.keys(competitorsByUnit).map(unitId => {
                const unit = units.find(u => u.id == unitId);
                const unitCompetitors = competitorsByUnit[unitId].sort((a, b) => a.position - b.position);

                return `
                    <div class="card">
                        <h4>${unit.name}${unit.number ? ` (${unit.number})` : ''}</h4>
                        <table>
                            <thead>
                                <tr><th>Lp.</th><th>Imie i Nazwisko</th><th>Plec</th><th>Status</th><th>Kod</th><th>Akcje</th></tr>
                            </thead>
                            <tbody>
                                ${unitCompetitors.map(competitor => `
                                    <tr class="${competitor.isPK ? 'pk-row' : ''}">
                                        <td>${competitor.position}</td>
                                        <td>${competitor.firstName} ${competitor.lastName}</td>
                                        <td>${competitor.gender === 'M' ? 'M' : 'K'}</td>
                                        <td>${competitor.isPK ? '<span class="text-warning">PK</span>' : '<span class="text-success">W konkurencji</span>'}</td>
                                        <td>${unit.number ? `${unit.number}/${competitor.position}` : '-'}</td>
                                        <td>
                                            <button onclick="moveCompetitor(${competitor.id}, 'up')">&#8593;</button>
                                            <button onclick="moveCompetitor(${competitor.id}, 'down')">&#8595;</button>
                                            <button onclick="deleteCompetitor(${competitor.id})" class="btn-danger">&#10005;</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
        }

        function moveCompetitor(competitorId, direction) {
            const competitor = competitors.find(c => c.id === competitorId);
            const unitCompetitors = competitors.filter(c => c.unitId === competitor.unitId).sort((a, b) => a.position - b.position);
            const currentIndex = unitCompetitors.findIndex(c => c.id === competitorId);

            if (direction === 'up' && currentIndex > 0) {
                const swapWith = unitCompetitors[currentIndex - 1];
                const tempPosition = competitor.position;
                competitor.position = swapWith.position;
                swapWith.position = tempPosition;
            } else if (direction === 'down' && currentIndex < unitCompetitors.length - 1) {
                const swapWith = unitCompetitors[currentIndex + 1];
                const tempPosition = competitor.position;
                competitor.position = swapWith.position;
                swapWith.position = tempPosition;
            }

            updateCompetitorsList();
        }

        function deleteCompetitor(competitorId) {
            if (confirm('Czy na pewno usunac zawodnika?')) {
                const competitor = competitors.find(c => c.id === competitorId);
                competitors = competitors.filter(c => c.id !== competitorId);

                const unitCompetitors = competitors.filter(c => c.unitId === competitor.unitId).sort((a, b) => a.position - b.position);
                unitCompetitors.forEach((comp, index) => {
                    comp.position = index + 1;
                });

                updateCompetitorsList();
                updateUnitsTable();
            }
        }

        // ==================== SCHEMA ====================

        function generateAutoSchema() {
            const numberedUnits = units.filter(u => u.number !== null).sort((a, b) => a.number - b.number);

            if (numberedUnits.length < 2) {
                alert('Potrzebujesz co najmniej 2 jednostki z numerami');
                return;
            }

            schema = [];

            // Generate separate schemas for men and women
            for (let i = 0; i < numberedUnits.length; i += 2) {
                if (i + 1 < numberedUnits.length) {
                    const unit1 = numberedUnits[i];
                    const unit2 = numberedUnits[i + 1];

                    // Men first
                    const maleComp1 = competitors.filter(c => c.unitId === unit1.id && !c.isPK && c.gender === 'M').sort((a, b) => a.position - b.position);
                    const maleComp2 = competitors.filter(c => c.unitId === unit2.id && !c.isPK && c.gender === 'M').sort((a, b) => a.position - b.position);

                    const maleMaxLen = Math.max(maleComp1.length, maleComp2.length);
                    for (let j = 0; j < maleMaxLen; j++) {
                        const comp1 = maleComp1[j];
                        const comp2 = maleComp2[j];
                        if (comp1 || comp2) {
                            schema.push({
                                id: Date.now() + schema.length + Math.random(),
                                leftLane: comp1 ? {
                                    unitNumber: unit1.number,
                                    position: comp1.position,
                                    competitorId: comp1.id,
                                    name: `${comp1.firstName} ${comp1.lastName}`
                                } : null,
                                rightLane: comp2 ? {
                                    unitNumber: unit2.number,
                                    position: comp2.position,
                                    competitorId: comp2.id,
                                    name: `${comp2.firstName} ${comp2.lastName}`
                                } : null
                            });
                        }
                    }

                    // Then women
                    const femaleComp1 = competitors.filter(c => c.unitId === unit1.id && !c.isPK && c.gender === 'K').sort((a, b) => a.position - b.position);
                    const femaleComp2 = competitors.filter(c => c.unitId === unit2.id && !c.isPK && c.gender === 'K').sort((a, b) => a.position - b.position);

                    const femaleMaxLen = Math.max(femaleComp1.length, femaleComp2.length);
                    for (let j = 0; j < femaleMaxLen; j++) {
                        const comp1 = femaleComp1[j];
                        const comp2 = femaleComp2[j];
                        if (comp1 || comp2) {
                            schema.push({
                                id: Date.now() + schema.length + Math.random(),
                                leftLane: comp1 ? {
                                    unitNumber: unit1.number,
                                    position: comp1.position,
                                    competitorId: comp1.id,
                                    name: `${comp1.firstName} ${comp1.lastName}`
                                } : null,
                                rightLane: comp2 ? {
                                    unitNumber: unit2.number,
                                    position: comp2.position,
                                    competitorId: comp2.id,
                                    name: `${comp2.firstName} ${comp2.lastName}`
                                } : null
                            });
                        }
                    }
                }
            }

            updateSchemaList();
        }

        function addManualRace() {
            const race = {
                id: Date.now(),
                leftLane: null,
                rightLane: null
            };

            schema.push(race);
            updateSchemaList();

            setTimeout(() => {
                editRace(race.id);
            }, 100);
        }

        function quickAddRace(leftUnit, leftPos, rightUnit, rightPos) {
            const race = {
                id: Date.now(),
                leftLane: null,
                rightLane: null
            };

            if (leftUnit && leftPos) {
                const unit = units.find(u => u.number == leftUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == leftPos && !c.isPK);
                if (competitor) {
                    race.leftLane = {
                        unitNumber: parseInt(leftUnit),
                        position: parseInt(leftPos),
                        competitorId: competitor.id,
                        name: `${competitor.firstName} ${competitor.lastName}`
                    };
                }
            }

            if (rightUnit && rightPos) {
                const unit = units.find(u => u.number == rightUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == rightPos && !c.isPK);
                if (competitor) {
                    race.rightLane = {
                        unitNumber: parseInt(rightUnit),
                        position: parseInt(rightPos),
                        competitorId: competitor.id,
                        name: `${competitor.firstName} ${competitor.lastName}`
                    };
                }
            }

            schema.push(race);
            updateSchemaList();
        }

        function clearSchema() {
            if (confirm('Czy na pewno wyczyscic caly schemat?')) {
                schema = [];
                updateSchemaList();
            }
        }

        function updateSchemaList() {
            const container = document.getElementById('schemaList');

            if (schema.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #718096;">Brak biegow w schemacie</p>';
                document.getElementById('startSeries1Btn').style.display = 'none';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr><th>Bieg</th><th>Tor Lewy</th><th>Tor Prawy</th><th>Akcje</th></tr>
                    </thead>
                    <tbody>
                        ${schema.map((race, index) => {
                            const leftGender = race.leftLane ? getCompetitorGender(race.leftLane.competitorId) : '';
                            const rightGender = race.rightLane ? getCompetitorGender(race.rightLane.competitorId) : '';
                            const genderLabel = leftGender || rightGender;
                            return `
                            <tr>
                                <td><strong>${index + 1}</strong> <span style="font-size:11px;color:#718096;">${genderLabel === 'K' ? '(K)' : genderLabel === 'M' ? '(M)' : ''}</span></td>
                                <td>${race.leftLane ? `${race.leftLane.unitNumber}/${race.leftLane.position} - ${race.leftLane.name}` : '-'}</td>
                                <td>${race.rightLane ? `${race.rightLane.unitNumber}/${race.rightLane.position} - ${race.rightLane.name}` : '-'}</td>
                                <td>
                                    <button onclick="editRace(${race.id})">Edytuj</button>
                                    <button onclick="deleteRace(${race.id})" class="btn-danger">Usun</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('startSeries1Btn').style.display = 'block';
        }

        function deleteRace(raceId) {
            if (confirm('Czy na pewno usunac ten bieg?')) {
                schema = schema.filter(r => r.id !== raceId);
                updateSchemaList();
            }
        }

        // ==================== EDIT RACE MODAL ====================

        function editRace(raceId) {
            editingRaceId = raceId;
            const race = schema.find(r => r.id === raceId);

            updateEditModalsSelects();

            // Set unit values first without triggering position reset
            const leftUnitSelect = document.getElementById('editLeftUnit');
            const rightUnitSelect = document.getElementById('editRightUnit');

            leftUnitSelect.value = race.leftLane ? race.leftLane.unitNumber : '';
            rightUnitSelect.value = race.rightLane ? race.rightLane.unitNumber : '';

            // Update position selects for both lanes
            updateSinglePositionSelect('editLeftPosition', 'editLeftName', leftUnitSelect.value);
            updateSinglePositionSelect('editRightPosition', 'editRightName', rightUnitSelect.value);

            // Now set position values
            if (race.leftLane) {
                document.getElementById('editLeftPosition').value = race.leftLane.position;
                updateCompetitorName('editLeftName', race.leftLane.unitNumber, race.leftLane.position);
            }

            if (race.rightLane) {
                document.getElementById('editRightPosition').value = race.rightLane.position;
                updateCompetitorName('editRightName', race.rightLane.unitNumber, race.rightLane.position);
            }

            document.getElementById('editRaceModal').classList.add('active');
        }

        function updateEditModalsSelects() {
            const leftSelect = document.getElementById('editLeftUnit');
            const rightSelect = document.getElementById('editRightUnit');

            if (leftSelect && rightSelect) {
                const unitOptions = '<option value="">Brak</option>' +
                    units.filter(u => u.number !== null)
                          .sort((a, b) => a.number - b.number)
                          .map(unit => `<option value="${unit.number}">${unit.number} - ${unit.name}</option>`)
                          .join('');

                leftSelect.innerHTML = unitOptions;
                rightSelect.innerHTML = unitOptions;

                // FIX: Only update the changed lane's position select
                leftSelect.onchange = () => {
                    updateSinglePositionSelect('editLeftPosition', 'editLeftName', leftSelect.value);
                };
                rightSelect.onchange = () => {
                    updateSinglePositionSelect('editRightPosition', 'editRightName', rightSelect.value);
                };
            }

            updateQuickSelects();
        }

        function updateSinglePositionSelect(positionSelectId, nameSpanId, unitNumber) {
            const positionSelect = document.getElementById(positionSelectId);

            if (!unitNumber) {
                positionSelect.innerHTML = '<option value="">-</option>';
                document.getElementById(nameSpanId).textContent = '';
                return;
            }

            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return;

            const unitCompetitors = competitors.filter(c => c.unitId === unit.id && !c.isPK).sort((a, b) => a.position - b.position);

            positionSelect.innerHTML = '<option value="">-</option>' +
                unitCompetitors.map(comp => `<option value="${comp.position}">${comp.position}</option>`).join('');

            positionSelect.onchange = () => updateCompetitorName(nameSpanId, unitNumber, positionSelect.value);
        }

        function updateQuickSelects() {
            const quickLeftUnit = document.getElementById('quickLeftUnit');
            const quickRightUnit = document.getElementById('quickRightUnit');

            if (quickLeftUnit && quickRightUnit) {
                const unitOptions = '<option value="">-</option>' +
                    units.filter(u => u.number !== null)
                          .sort((a, b) => a.number - b.number)
                          .map(unit => `<option value="${unit.number}">${unit.number}</option>`)
                          .join('');

                quickLeftUnit.innerHTML = unitOptions;
                quickRightUnit.innerHTML = unitOptions;

                quickLeftUnit.onchange = () => {
                    updateQuickPositionSelect('quickLeftPos', quickLeftUnit.value);
                    updateQuickPreview();
                };
                quickRightUnit.onchange = () => {
                    updateQuickPositionSelect('quickRightPos', quickRightUnit.value);
                    updateQuickPreview();
                };

                document.getElementById('quickLeftPos').onchange = () => updateQuickPreview();
                document.getElementById('quickRightPos').onchange = () => updateQuickPreview();
            }
        }

        function updateQuickPositionSelect(selectId, unitNumber) {
            const select = document.getElementById(selectId);

            if (!unitNumber) {
                select.innerHTML = '<option value="">-</option>';
                return;
            }

            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return;

            const unitCompetitors = competitors.filter(c => c.unitId === unit.id && !c.isPK).sort((a, b) => a.position - b.position);

            select.innerHTML = '<option value="">-</option>' +
                unitCompetitors.map(comp => `<option value="${comp.position}">${comp.position}</option>`).join('');
        }

        function updateQuickPreview() {
            const leftUnit = document.getElementById('quickLeftUnit').value;
            const leftPos = document.getElementById('quickLeftPos').value;
            const rightUnit = document.getElementById('quickRightUnit').value;
            const rightPos = document.getElementById('quickRightPos').value;

            let preview = 'Lewy: ';
            if (leftUnit && leftPos) {
                const name = getCompetitorNameByCode(leftUnit, leftPos);
                preview += `${leftUnit}/${leftPos} - ${name}`;
            } else {
                preview += '-';
            }

            preview += ' vs Prawy: ';
            if (rightUnit && rightPos) {
                const name = getCompetitorNameByCode(rightUnit, rightPos);
                preview += `${rightUnit}/${rightPos} - ${name}`;
            } else {
                preview += '-';
            }

            document.getElementById('quickPreview').textContent = preview;
        }

        function getCompetitorNameByCode(unitNumber, position) {
            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return 'Nieznany';

            const competitor = competitors.find(c => c.unitId === unit.id && c.position == position && !c.isPK);
            return competitor ? `${competitor.firstName} ${competitor.lastName}` : 'Nieznany';
        }

        function addQuickRace() {
            const leftUnit = document.getElementById('quickLeftUnit').value;
            const leftPos = document.getElementById('quickLeftPos').value;
            const rightUnit = document.getElementById('quickRightUnit').value;
            const rightPos = document.getElementById('quickRightPos').value;

            if (!leftUnit && !rightUnit) {
                alert('Wybierz przynajmniej jednego zawodnika');
                return;
            }

            quickAddRace(leftUnit, leftPos, rightUnit, rightPos);

            document.getElementById('quickLeftUnit').value = '';
            document.getElementById('quickLeftPos').value = '';
            document.getElementById('quickRightUnit').value = '';
            document.getElementById('quickRightPos').value = '';
            updateQuickPreview();
        }

        function updateCompetitorName(nameSpanId, unitNumber, position) {
            const nameSpan = document.getElementById(nameSpanId);

            if (!unitNumber || !position) {
                nameSpan.textContent = '';
                return;
            }

            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return;

            const competitor = competitors.find(c => c.unitId === unit.id && c.position == position && !c.isPK);
            nameSpan.textContent = competitor ? `(${competitor.firstName} ${competitor.lastName})` : '';
        }

        function saveRaceEdit() {
            const leftUnit = document.getElementById('editLeftUnit').value;
            const leftPosition = document.getElementById('editLeftPosition').value;
            const rightUnit = document.getElementById('editRightUnit').value;
            const rightPosition = document.getElementById('editRightPosition').value;

            const race = schema.find(r => r.id === editingRaceId);

            if (leftUnit && leftPosition) {
                const unit = units.find(u => u.number == leftUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == leftPosition && !c.isPK);
                race.leftLane = {
                    unitNumber: parseInt(leftUnit),
                    position: parseInt(leftPosition),
                    competitorId: competitor.id,
                    name: `${competitor.firstName} ${competitor.lastName}`
                };
            } else {
                race.leftLane = null;
            }

            if (rightUnit && rightPosition) {
                const unit = units.find(u => u.number == rightUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == rightPosition && !c.isPK);
                race.rightLane = {
                    unitNumber: parseInt(rightUnit),
                    position: parseInt(rightPosition),
                    competitorId: competitor.id,
                    name: `${competitor.firstName} ${competitor.lastName}`
                };
            } else {
                race.rightLane = null;
            }

            updateSchemaList();
            closeEditModal();
        }

        function closeEditModal() {
            document.getElementById('editRaceModal').classList.remove('active');
            editingRaceId = null;
        }

        // ==================== SERIES 1 ====================

        function startSeries1() {
            if (schema.length === 0) {
                alert('Brak biegow w schemacie');
                return;
            }

            series1Results = schema.map(race => ({
                ...race,
                leftResult: race.leftLane ? { time: '', status: 'OK' } : null,
                rightResult: race.rightLane ? { time: '', status: 'OK' } : null
            }));

            updateSeries1List();
            showSection('series1');
        }

        function getUnitNameByNumber(unitNumber) {
            const unit = units.find(u => u.number === unitNumber);
            return unit ? unit.name : '';
        }

        function updateSeries1List() {
            const container = document.getElementById('series1List');

            container.innerHTML = `
                <table>
                    <thead>
                        <tr><th>Bieg</th><th>Tor Lewy</th><th>Czas (MM:SS)</th><th>Status</th><th>Tor Prawy</th><th>Czas (MM:SS)</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        ${series1Results.map((race, index) => `
                            <tr>
                                <td><strong>${index + 1}</strong></td>
                                <td>${race.leftLane ? `<strong>${race.leftLane.unitNumber}/${race.leftLane.position}</strong><br><small>${race.leftLane.name}</small><br><small style="color:#718096;">${getUnitNameByNumber(race.leftLane.unitNumber)}</small>` : '-'}</td>
                                <td>${race.leftLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.leftResult.time}" onchange="updateResult(1, ${race.id}, 'left', 'time', this.value)">` : '-'}</td>
                                <td>${race.leftLane ? `
                                    <select class="status-select" onchange="updateResult(1, ${race.id}, 'left', 'status', this.value)">
                                        <option value="OK" ${race.leftResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.leftResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.leftResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                                <td>${race.rightLane ? `<strong>${race.rightLane.unitNumber}/${race.rightLane.position}</strong><br><small>${race.rightLane.name}</small><br><small style="color:#718096;">${getUnitNameByNumber(race.rightLane.unitNumber)}</small>` : '-'}</td>
                                <td>${race.rightLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.rightResult.time}" onchange="updateResult(1, ${race.id}, 'right', 'time', this.value)">` : '-'}</td>
                                <td>${race.rightLane ? `
                                    <select class="status-select" onchange="updateResult(1, ${race.id}, 'right', 'status', this.value)">
                                        <option value="OK" ${race.rightResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.rightResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.rightResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('startSeries2Btn').style.display = 'block';
        }

        function updateResult(series, raceId, lane, field, value) {
            const results = series === 1 ? series1Results : series2Results;
            const race = results.find(r => r.id === raceId);

            if (race) {
                const laneKey = lane === 'left' ? 'leftResult' : 'rightResult';
                if (race[laneKey]) {
                    race[laneKey][field] = value;
                }
            }

            // Update live results window if open
            updateLiveResults();
        }

        // ==================== SERIES 2 ====================
        // Separate brackets for men and women

        function startSeries2() {
            if (series1Results.length === 0) {
                alert('Najpierw musisz zakonczyc pierwsza serie');
                return;
            }

            // Collect all competitors from series 1 with their results
            const allS1Competitors = [];
            series1Results.forEach(race => {
                if (race.leftLane && race.leftResult) {
                    allS1Competitors.push({
                        lane: race.leftLane,
                        result: race.leftResult,
                        originalSide: 'left'
                    });
                }
                if (race.rightLane && race.rightResult) {
                    allS1Competitors.push({
                        lane: race.rightLane,
                        result: race.rightResult,
                        originalSide: 'right'
                    });
                }
            });

            // Separate by gender
            const maleCompetitors = allS1Competitors.filter(c => getCompetitorGender(c.lane.competitorId) === 'M');
            const femaleCompetitors = allS1Competitors.filter(c => getCompetitorGender(c.lane.competitorId) === 'K');

            // Generate series 2 races for each gender separately
            const maleRaces = generateSeries2Races(maleCompetitors);
            const femaleRaces = generateSeries2Races(femaleCompetitors);

            series2Results = [...maleRaces, ...femaleRaces];
            updateSeries2List();
            showSection('series2');
        }

        function generateSeries2Races(genderCompetitors) {
            // In series 2, competitors switch lanes (left->right, right->left)
            // Sort: DDF/DSQ first, then worst times, then best times
            const leftLaneCompetitors = []; // Were on right in S1, go to left in S2
            const rightLaneCompetitors = []; // Were on left in S1, go to right in S2

            genderCompetitors.forEach(c => {
                const entry = {
                    ...c.lane,
                    result: c.result,
                    timeInSeconds: timeToSeconds(c.result.time)
                };
                if (c.originalSide === 'left') {
                    rightLaneCompetitors.push(entry); // Switch to right
                } else {
                    leftLaneCompetitors.push(entry); // Switch to left
                }
            });

            const sortCompetitors = (comps) => {
                return comps.sort((a, b) => {
                    if (a.result.status !== 'OK') {
                        if (b.result.status !== 'OK') return 0;
                        return -1;
                    }
                    if (b.result.status !== 'OK') return 1;
                    return b.timeInSeconds - a.timeInSeconds; // Worst times first
                });
            };

            const sortedLeft = sortCompetitors([...leftLaneCompetitors]);
            const sortedRight = sortCompetitors([...rightLaneCompetitors]);

            const races = [];
            const leftCount = sortedLeft.length;
            const rightCount = sortedRight.length;
            const diff = Math.abs(leftCount - rightCount);

            if (diff > 0) {
                const moreCompetitors = leftCount > rightCount ? sortedLeft : sortedRight;
                const laneName = leftCount > rightCount ? 'left' : 'right';

                for (let i = 0; i < diff; i++) {
                    const competitor = moreCompetitors[i];
                    const raceItem = {
                        id: Date.now() + races.length + Math.random(),
                        leftLane: null,
                        rightLane: null,
                        leftResult: null,
                        rightResult: null
                    };

                    if (laneName === 'left') {
                        raceItem.leftLane = competitor;
                        raceItem.leftResult = { time: '', status: 'OK' };
                    } else {
                        raceItem.rightLane = competitor;
                        raceItem.rightResult = { time: '', status: 'OK' };
                    }

                    races.push(raceItem);
                }

                if (leftCount > rightCount) {
                    sortedLeft.splice(0, diff);
                } else {
                    sortedRight.splice(0, diff);
                }
            }

            const pairCount = Math.min(sortedLeft.length, sortedRight.length);

            for (let i = 0; i < pairCount; i++) {
                races.push({
                    id: Date.now() + races.length + Math.random(),
                    leftLane: sortedLeft[i],
                    rightLane: sortedRight[i],
                    leftResult: { time: '', status: 'OK' },
                    rightResult: { time: '', status: 'OK' }
                });
            }

            return races;
        }

        function updateSeries2List() {
            const container = document.getElementById('series2List');

            // Separate races by gender for display
            const maleRaces = [];
            const femaleRaces = [];

            series2Results.forEach(race => {
                const compId = (race.leftLane && race.leftLane.competitorId) || (race.rightLane && race.rightLane.competitorId);
                if (compId && getCompetitorGender(compId) === 'K') {
                    femaleRaces.push(race);
                } else {
                    maleRaces.push(race);
                }
            });

            let html = '';

            if (maleRaces.length > 0) {
                html += `
                <div class="gender-section gender-section-male">
                    <h4>Mezczyzni - II Seria</h4>
                    ${generateSeries2Table(maleRaces, 0)}
                </div>`;
            }

            if (femaleRaces.length > 0) {
                html += `
                <div class="gender-section gender-section-female">
                    <h4>Kobiety - II Seria</h4>
                    ${generateSeries2Table(femaleRaces, maleRaces.length)}
                </div>`;
            }

            container.innerHTML = html;
            document.getElementById('generateResultsBtn').style.display = 'block';
        }

        function generateSeries2Table(races, startIndex) {
            return `
                <table>
                    <thead>
                        <tr><th>Bieg</th><th>Tor Lewy</th><th>I Seria</th><th>Czas II (MM:SS)</th><th>Status</th><th>Tor Prawy</th><th>I Seria</th><th>Czas II (MM:SS)</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        ${races.map((race, index) => `
                            <tr>
                                <td><strong>${startIndex + index + 1}</strong></td>
                                <td>${race.leftLane ? `<strong>${race.leftLane.unitNumber}/${race.leftLane.position}</strong><br><small>${race.leftLane.name}</small><br><small style="color:#718096;">${getUnitNameByNumber(race.leftLane.unitNumber)}</small>` : '-'}</td>
                                <td>${race.leftLane ? `${race.leftLane.result.time || '-'} (${race.leftLane.result.status})` : '-'}</td>
                                <td>${race.leftLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.leftResult.time}" onchange="updateResult(2, ${race.id}, 'left', 'time', this.value)">` : '-'}</td>
                                <td>${race.leftLane ? `
                                    <select class="status-select" onchange="updateResult(2, ${race.id}, 'left', 'status', this.value)">
                                        <option value="OK" ${race.leftResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.leftResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.leftResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                                <td>${race.rightLane ? `<strong>${race.rightLane.unitNumber}/${race.rightLane.position}</strong><br><small>${race.rightLane.name}</small><br><small style="color:#718096;">${getUnitNameByNumber(race.rightLane.unitNumber)}</small>` : '-'}</td>
                                <td>${race.rightLane ? `${race.rightLane.result.time || '-'} (${race.rightLane.result.status})` : '-'}</td>
                                <td>${race.rightLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.rightResult.time}" onchange="updateResult(2, ${race.id}, 'right', 'time', this.value)">` : '-'}</td>
                                <td>${race.rightLane ? `
                                    <select class="status-select" onchange="updateResult(2, ${race.id}, 'right', 'status', this.value)">
                                        <option value="OK" ${race.rightResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.rightResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.rightResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ==================== FINAL RESULTS ====================

        function generateFinalResults() {
            const finalResults = calculateFinalResults();
            updateFinalResultsList(finalResults);
            showSection('results');
        }

        function calculateFinalResults() {
            const allCompetitors = new Map();

            series1Results.forEach(race => {
                if (race.leftLane && race.leftResult) {
                    allCompetitors.set(race.leftLane.competitorId, {
                        ...race.leftLane,
                        series1: race.leftResult,
                        series2: null
                    });
                }
                if (race.rightLane && race.rightResult) {
                    allCompetitors.set(race.rightLane.competitorId, {
                        ...race.rightLane,
                        series1: race.rightResult,
                        series2: null
                    });
                }
            });

            series2Results.forEach(race => {
                if (race.leftLane && race.leftResult) {
                    const competitor = allCompetitors.get(race.leftLane.competitorId);
                    if (competitor) {
                        competitor.series2 = race.leftResult;
                    }
                }
                if (race.rightLane && race.rightResult) {
                    const competitor = allCompetitors.get(race.rightLane.competitorId);
                    if (competitor) {
                        competitor.series2 = race.rightResult;
                    }
                }
            });

            const results = [];
            allCompetitors.forEach(comp => {
                const competitorData = competitors.find(c => c.id === comp.competitorId);
                if (!competitorData) return;
                const unit = units.find(u => u.id === competitorData.unitId);

                let bestTime = null;
                let bestTimeSeries = null;
                let bestTimeSeconds = 9999;

                if (comp.series1 && comp.series1.status === 'OK' && comp.series1.time) {
                    const time1 = timeToSeconds(comp.series1.time);
                    if (time1 < bestTimeSeconds) {
                        bestTime = comp.series1.time;
                        bestTimeSeries = 1;
                        bestTimeSeconds = time1;
                    }
                }

                if (comp.series2 && comp.series2.status === 'OK' && comp.series2.time) {
                    const time2 = timeToSeconds(comp.series2.time);
                    if (time2 < bestTimeSeconds) {
                        bestTime = comp.series2.time;
                        bestTimeSeries = 2;
                        bestTimeSeconds = time2;
                    }
                }

                // Determine display result when no valid time
                let displayResult = bestTime || '-';
                if (!bestTime) {
                    const s1status = comp.series1 ? comp.series1.status : null;
                    const s2status = comp.series2 ? comp.series2.status : null;
                    const hasDSQ = s1status === 'DSQ' || s2status === 'DSQ';
                    const hasDDF = s1status === 'DDF' || s2status === 'DDF';
                    if (hasDSQ) {
                        displayResult = 'DSQ';
                    } else if (hasDDF) {
                        displayResult = 'DDF';
                    }
                }

                results.push({
                    ...competitorData,
                    unitName: unit ? unit.name : '',
                    unitNumber: comp.unitNumber,
                    competitorPosition: comp.position,
                    series1: comp.series1,
                    series2: comp.series2,
                    bestTime: bestTime,
                    bestTimeSeries: bestTimeSeries,
                    bestTimeSeconds: bestTimeSeconds,
                    displayResult: displayResult
                });
            });

            const regularResults = results.filter(r => !r.isPK);
            const pkResults = results.filter(r => r.isPK);

            const maleResults = regularResults.filter(r => r.gender === 'M');
            const femaleResults = regularResults.filter(r => r.gender === 'K');

            const sortResults = (results) => {
                return results.sort((a, b) => {
                    const aTotalDQ = (!a.series1 || a.series1.status !== 'OK') && (!a.series2 || a.series2.status !== 'OK');
                    const bTotalDQ = (!b.series1 || b.series1.status !== 'OK') && (!b.series2 || b.series2.status !== 'OK');

                    if (aTotalDQ && !bTotalDQ) return 1;
                    if (!aTotalDQ && bTotalDQ) return -1;
                    if (aTotalDQ && bTotalDQ) return a.lastName.localeCompare(b.lastName);

                    if (a.bestTime && b.bestTime) {
                        return a.bestTimeSeconds - b.bestTimeSeconds;
                    }

                    if (a.bestTime) return -1;
                    if (b.bestTime) return 1;

                    return a.lastName.localeCompare(b.lastName);
                });
            };

            const sortedMale = sortResults([...maleResults]);
            const sortedFemale = sortResults([...femaleResults]);
            const sortedPK = sortResults([...pkResults]);

            const addPositions = (results) => {
                let position = 1;
                results.forEach((result, index) => {
                    const hasTotalDQ = (!result.series1 || result.series1.status !== 'OK') && (!result.series2 || result.series2.status !== 'OK');

                    if (hasTotalDQ) {
                        result.finalPosition = 'DQ';
                    } else if (result.bestTime) {
                        if (index > 0 && results[index-1].bestTime === result.bestTime && results[index-1].finalPosition !== 'DQ') {
                            result.finalPosition = results[index-1].finalPosition;
                        } else {
                            result.finalPosition = position;
                        }
                    } else {
                        result.finalPosition = '-';
                    }
                    position++;
                });
            };

            addPositions(sortedMale);
            addPositions(sortedFemale);
            addPositions(sortedPK);

            return {
                male: sortedMale,
                female: sortedFemale,
                pk: sortedPK
            };
        }

        function showResults(category) {
            currentResultsView = category;
            document.querySelectorAll('.results-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`results${category}Btn`).classList.add('active');

            const finalResults = calculateFinalResults();
            updateFinalResultsList(finalResults);
        }

        function updateFinalResultsList(finalResults) {
            const container = document.getElementById('finalResultsList');
            let html = '';

            const renderTable = (title, results, cssClass) => {
                if (results.length === 0) return '';
                return `
                    <div class="gender-section ${cssClass}">
                        <h4>${title}</h4>
                        <table>
                            <thead>
                                <tr><th>Miejsce</th><th>Imie i Nazwisko</th><th>Jednostka</th><th>I Seria</th><th>II Seria</th><th>Najlepszy czas</th></tr>
                            </thead>
                            <tbody>
                                ${results.map(result => `
                                    <tr>
                                        <td><strong>${result.finalPosition}</strong></td>
                                        <td><strong>${result.firstName} ${result.lastName}</strong></td>
                                        <td>${result.unitName}</td>
                                        <td>${result.series1 ? `${result.series1.time || '-'} (${result.series1.status})` : '-'}</td>
                                        <td>${result.series2 ? `${result.series2.time || '-'} (${result.series2.status})` : '-'}</td>
                                        <td><strong style="color: #38a169;">${result.displayResult}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            if (currentResultsView === 'M') {
                html += renderTable('Klasyfikacja Mezczyzn', finalResults.male, 'gender-section-male');
            } else if (currentResultsView === 'K') {
                html += renderTable('Klasyfikacja Kobiet', finalResults.female, 'gender-section-female');
            }

            if (finalResults.pk.length > 0) {
                const pkGender = currentResultsView === 'K' ? finalResults.pk.filter(r => r.gender === 'K') :
                                 currentResultsView === 'M' ? finalResults.pk.filter(r => r.gender === 'M') : finalResults.pk;
                if (pkGender.length > 0) {
                    html += `
                    <div style="margin-top: 24px; padding: 16px; background: #fffff0; border: 1px solid #ecc94b; border-radius: 8px;">
                        <h4 style="color: #975a16; margin-bottom: 12px;">Zawodnicy Poza Konkurencja (PK)</h4>
                        <table>
                            <thead>
                                <tr><th>Lp.</th><th>Imie i Nazwisko</th><th>Jednostka</th><th>I Seria</th><th>II Seria</th><th>Najlepszy czas</th></tr>
                            </thead>
                            <tbody>
                                ${pkGender.map((result, index) => `
                                    <tr>
                                        <td><strong>PK-${index + 1}</strong></td>
                                        <td><strong>${result.firstName} ${result.lastName}</strong></td>
                                        <td>${result.unitName}</td>
                                        <td>${result.series1 ? `${result.series1.time || '-'} (${result.series1.status})` : '-'}</td>
                                        <td>${result.series2 ? `${result.series2.time || '-'} (${result.series2.status})` : '-'}</td>
                                        <td><strong style="color: #38a169;">${result.displayResult}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
                }
            }

            container.innerHTML = html;
        }

        // ==================== PRINTING ====================

        function printSection(sectionId) {
            const eventName = document.getElementById('eventName').value;
            const eventLocation = document.getElementById('eventLocation').value;
            const currentDate = new Date().toLocaleDateString('pl-PL');

            let printContent = '';
            let title = '';

            if (sectionId === 'schema') {
                title = 'SCHEMAT BIEGOW - I SERIA';
                printContent = generateSchemaPrint();
            } else if (sectionId === 'series1') {
                title = 'LISTA STARTOWA - I SERIA';
                printContent = generateSeries1Print();
            } else if (sectionId === 'series2') {
                title = 'LISTA STARTOWA - II SERIA';
                printContent = generateSeries2Print();
            } else if (sectionId === 'results') {
                title = 'WYNIKI KONCOWE';
                printContent = generateResultsPrint();
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>OSF - ${title}</title>
                        <meta charset="UTF-8">
                        <style>
                            @page { size: A4 portrait; margin: 15mm; }
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 13px; line-height: 1.4; color: #1a202c; margin: 0; padding: 0; }
                            .header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px double #2d3748; }
                            .logo { font-size: 20px; font-weight: bold; color: #2d3748; margin-bottom: 5px; }
                            .title { font-size: 18px; font-weight: bold; margin: 10px 0; text-transform: uppercase; letter-spacing: 1px; color: #2d3748; }
                            .event-info { margin: 15px 0; padding: 10px; background: #f7fafc; border-left: 4px solid #3182ce; }
                            .event-info .name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
                            .event-info .location { font-size: 14px; color: #718096; }
                            .meta-info { display: flex; justify-content: space-between; margin: 15px 0; font-size: 11px; color: #718096; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 13px; }
                            th { background: #2d3748; color: white; padding: 8px 6px; text-align: center; font-weight: bold; border: 1px solid #2d3748; font-size: 12px; }
                            td { padding: 8px 6px; border: 1px solid #cbd5e0; text-align: center; vertical-align: middle; }
                            tr:nth-child(even) { background: #f7fafc; }
                            .race-number { font-weight: bold; font-size: 14px; background: #edf2f7 !important; }
                            .competitor-info { text-align: left; padding-left: 8px; }
                            .competitor-code { font-weight: bold; color: #3182ce; font-size: 14px; }
                            .competitor-name { font-size: 13px; color: #2d3748; margin-top: 2px; }
                            .unit-name { font-size: 11px; color: #718096; font-style: italic; }
                            .time-cell { min-width: 60px; }
                            .time-filled { font-weight: bold; color: #2d3748; }
                            .status-cell { min-width: 45px; }
                            .result-position { font-weight: bold; font-size: 16px; color: #3182ce; }
                            .best-time { font-weight: bold; color: #38a169; font-size: 14px; }
                            .section-title { color: #2d3748; font-size: 14px; font-weight: bold; padding: 8px 12px; margin-top: 24px; margin-bottom: 0; }
                            .section-title-male { background: #ebf4ff; border-left: 4px solid #3182ce; }
                            .section-title-female { background: #fff5f5; border-left: 4px solid #e53e3e; }
                            .pk-section { margin-top: 30px; padding: 15px; background: #fffff0; border: 2px solid #ecc94b; border-radius: 5px; }
                            .pk-title { font-weight: bold; color: #975a16; text-align: center; margin-bottom: 10px; font-size: 12px; }
                            .footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #e2e8f0; text-align: center; font-size: 10px; color: #718096; }
                            .signature-area { margin-top: 40px; display: flex; justify-content: space-between; }
                            .signature-box { width: 200px; text-align: center; }
                            .signature-line { border-top: 1px solid #2d3748; margin-top: 40px; padding-top: 5px; font-size: 10px; }
                            @media print { body { print-color-adjust: exact; } .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="logo">OSF - OSRODEK SPRAWNOSCI FIZYCZNEJ</div>
                            <div class="title">${title}</div>
                            ${(eventName || eventLocation) ? `
                                <div class="event-info">
                                    ${eventName ? `<div class="name">${eventName}</div>` : ''}
                                    ${eventLocation ? `<div class="location">Miejscowosc: ${eventLocation}</div>` : ''}
                                </div>
                            ` : ''}
                            <div class="meta-info">
                                <span>Data wydruku: ${currentDate}</span>
                                <span>System OSF v2.0</span>
                            </div>
                        </div>

                        ${printContent}

                        <div class="signature-area">
                            <div class="signature-box">
                                <div class="signature-line">Sedzia Glowny</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line">Sedzia techniczny</div>
                            </div>
                        </div>

                        <div class="footer">
                            <div>Opracowanie: YO&GO Events | System OSF</div>
                            <div style="margin-top: 5px;">Wydrukowano: ${new Date().toLocaleString('pl-PL')}</div>
                        </div>

                        <div class="no-print" style="position: fixed; top: 10px; right: 10px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #3182ce; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">Drukuj</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #e53e3e; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">Zamknij</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        function generateSchemaPrint() {
            if (schema.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak zdefiniowanych biegow w schemacie.</p>';
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 60px;">BIEG</th>
                            <th style="width: 40%;">TOR LEWY</th>
                            <th style="width: 40%;">TOR PRAWY</th>
                            <th style="width: 100px;">UWAGI</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${schema.map((race, index) => `
                            <tr>
                                <td class="race-number">${index + 1}</td>
                                <td class="competitor-info">
                                    ${race.leftLane ? `
                                        <div class="competitor-code">${race.leftLane.unitNumber}/${race.leftLane.position}</div>
                                        <div class="competitor-name">${race.leftLane.name}</div>
                                        <div class="unit-name">${getUnitNameByNumber(race.leftLane.unitNumber)}</div>
                                    ` : '<span style="color: #999;">-</span>'}
                                </td>
                                <td class="competitor-info">
                                    ${race.rightLane ? `
                                        <div class="competitor-code">${race.rightLane.unitNumber}/${race.rightLane.position}</div>
                                        <div class="competitor-name">${race.rightLane.name}</div>
                                        <div class="unit-name">${getUnitNameByNumber(race.rightLane.unitNumber)}</div>
                                    ` : '<span style="color: #999;">-</span>'}
                                </td>
                                <td style="background: #f7fafc;"></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div style="margin-top: 30px; padding: 15px; background: #ebf8ff; border-left: 4px solid #3182ce;">
                    <strong>Informacje:</strong><br>
                    Liczba biegow: ${schema.length}<br>
                    W II serii nastapi bezwzgledna zmiana torow
                </div>
            `;
        }

        function generateSeries1Print() {
            if (series1Results.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak listy startowej I serii.</p>';
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">BIEG</th>
                            <th style="width: 35%;">TOR LEWY</th>
                            <th style="width: 70px;">CZAS</th>
                            <th style="width: 50px;">STATUS</th>
                            <th style="width: 35%;">TOR PRAWY</th>
                            <th style="width: 70px;">CZAS</th>
                            <th style="width: 50px;">STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${series1Results.map((race, index) => {
                            const leftHasResult = race.leftResult && race.leftResult.time;
                            const rightHasResult = race.rightResult && race.rightResult.time;
                            return `
                            <tr>
                                <td class="race-number">${index + 1}</td>
                                <td class="competitor-info">
                                    ${race.leftLane ? `
                                        <div class="competitor-code">${race.leftLane.unitNumber}/${race.leftLane.position}</div>
                                        <div class="competitor-name">${race.leftLane.name}</div>
                                        <div class="unit-name">${getUnitNameByNumber(race.leftLane.unitNumber)}</div>
                                    ` : '-'}
                                </td>
                                <td class="time-cell">${leftHasResult ? `<span class="time-filled">${race.leftResult.time}</span>` : '_____:_____'}</td>
                                <td class="status-cell">${leftHasResult ? race.leftResult.status : '_____'}</td>
                                <td class="competitor-info">
                                    ${race.rightLane ? `
                                        <div class="competitor-code">${race.rightLane.unitNumber}/${race.rightLane.position}</div>
                                        <div class="competitor-name">${race.rightLane.name}</div>
                                        <div class="unit-name">${getUnitNameByNumber(race.rightLane.unitNumber)}</div>
                                    ` : '-'}
                                </td>
                                <td class="time-cell">${rightHasResult ? `<span class="time-filled">${race.rightResult.time}</span>` : '_____:_____'}</td>
                                <td class="status-cell">${rightHasResult ? race.rightResult.status : '_____'}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 10px; background: #f7fafc; border: 1px solid #e2e8f0;">
                    <strong>Oznaczenia statusow:</strong> OK - ukonczyl, DDF - nie ukonczyl, DSQ - dyskwalifikacja
                </div>
            `;
        }

        function generateSeries2Print() {
            if (series2Results.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak listy startowej II serii.</p>';
            }

            // Separate by gender
            const maleRaces = [];
            const femaleRaces = [];

            series2Results.forEach(race => {
                const compId = (race.leftLane && race.leftLane.competitorId) || (race.rightLane && race.rightLane.competitorId);
                if (compId && getCompetitorGender(compId) === 'K') {
                    femaleRaces.push(race);
                } else {
                    maleRaces.push(race);
                }
            });

            let content = `
                <div style="margin-bottom: 20px; padding: 15px; background: #fffff0; border-left: 4px solid #ecc94b;">
                    <strong>ZASADY II SERII:</strong><br>
                    Bezwzgledna zmiana torow (lewy - prawy)<br>
                    Kolejnosc: DDF/DSQ - najgorsze czasy - najlepsze czasy<br>
                    Oddzielne drabinki dla kobiet i mezczyzn
                </div>
            `;

            if (maleRaces.length > 0) {
                content += `<div class="section-title section-title-male">MEZCZYZNI</div>`;
                content += generateSeries2PrintTable(maleRaces, 0);
            }

            if (femaleRaces.length > 0) {
                content += `<div class="section-title section-title-female" style="margin-top: 24px;">KOBIETY</div>`;
                content += generateSeries2PrintTable(femaleRaces, maleRaces.length);
            }

            return content;
        }

        function generateSeries2PrintTable(races, startIndex) {
            return `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">BIEG</th>
                            <th style="width: 25%;">TOR LEWY</th>
                            <th style="width: 60px;">I SERIA</th>
                            <th style="width: 70px;">CZAS II</th>
                            <th style="width: 50px;">STATUS</th>
                            <th style="width: 25%;">TOR PRAWY</th>
                            <th style="width: 60px;">I SERIA</th>
                            <th style="width: 70px;">CZAS II</th>
                            <th style="width: 50px;">STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${races.map((race, index) => {
                            const leftHasResult = race.leftResult && race.leftResult.time;
                            const rightHasResult = race.rightResult && race.rightResult.time;
                            return `
                            <tr>
                                <td class="race-number">${startIndex + index + 1}</td>
                                <td class="competitor-info">
                                    ${race.leftLane ? `
                                        <div class="competitor-code">${race.leftLane.unitNumber}/${race.leftLane.position}</div>
                                        <div class="competitor-name">${race.leftLane.name}</div>
                                        <div class="unit-name">${getUnitNameByNumber(race.leftLane.unitNumber)}</div>
                                    ` : '-'}
                                </td>
                                <td style="font-size: 9px;">
                                    ${race.leftLane ? `${race.leftLane.result.time || '-'}<br>(${race.leftLane.result.status})` : '-'}
                                </td>
                                <td class="time-cell">${leftHasResult ? `<span class="time-filled">${race.leftResult.time}</span>` : '_____:_____'}</td>
                                <td class="status-cell">${leftHasResult ? race.leftResult.status : '_____'}</td>
                                <td class="competitor-info">
                                    ${race.rightLane ? `
                                        <div class="competitor-code">${race.rightLane.unitNumber}/${race.rightLane.position}</div>
                                        <div class="competitor-name">${race.rightLane.name}</div>
                                        <div class="unit-name">${getUnitNameByNumber(race.rightLane.unitNumber)}</div>
                                    ` : '-'}
                                </td>
                                <td style="font-size: 9px;">
                                    ${race.rightLane ? `${race.rightLane.result.time || '-'}<br>(${race.rightLane.result.status})` : '-'}
                                </td>
                                <td class="time-cell">${rightHasResult ? `<span class="time-filled">${race.rightResult.time}</span>` : '_____:_____'}</td>
                                <td class="status-cell">${rightHasResult ? race.rightResult.status : '_____'}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateResultsPrint() {
            if (series1Results.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak wynikow do wyswietlenia.</p>';
            }

            const finalResults = calculateFinalResults();
            let content = '';

            const renderResultTable = (results) => {
                return `
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 60px;">MIEJSCE</th>
                                <th style="width: 30%;">ZAWODNIK</th>
                                <th style="width: 20%;">JEDNOSTKA</th>
                                <th style="width: 80px;">I SERIA</th>
                                <th style="width: 80px;">II SERIA</th>
                                <th style="width: 80px;">NAJLEPSZY</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(result => `
                                <tr>
                                    <td class="result-position">${result.finalPosition}</td>
                                    <td class="competitor-info">
                                        <div class="competitor-name" style="font-weight: bold;">${result.firstName} ${result.lastName}</div>
                                    </td>
                                    <td style="text-align: left; padding-left: 8px;">${result.unitName}</td>
                                    <td style="font-size: 10px;">
                                        ${result.series1 ? `${result.series1.time || '-'}<br><span style="color: #718096;">(${result.series1.status})</span>` : '-'}
                                    </td>
                                    <td style="font-size: 10px;">
                                        ${result.series2 ? `${result.series2.time || '-'}<br><span style="color: #718096;">(${result.series2.status})</span>` : '-'}
                                    </td>
                                    <td class="best-time">${result.displayResult}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            };

            if (finalResults.male.length > 0) {
                content += `<div class="section-title section-title-male">KLASYFIKACJA MEZCZYZN</div>`;
                content += renderResultTable(finalResults.male);
            }

            if (finalResults.female.length > 0) {
                content += `<div class="section-title section-title-female" style="margin-top: 24px;">KLASYFIKACJA KOBIET</div>`;
                content += renderResultTable(finalResults.female);
            }

            if (finalResults.pk.length > 0) {
                content += `
                    <div class="pk-section">
                        <div class="pk-title">ZAWODNICY POZA KONKURENCJA (PK)</div>
                        ${renderResultTable(finalResults.pk)}
                    </div>
                `;
            }

            const totalCompetitors = finalResults.male.length + finalResults.female.length;
            const totalPK = finalResults.pk.length;
            const totalDQ = [...finalResults.male, ...finalResults.female].filter(r => r.finalPosition === 'DQ').length;

            content += `
                <div style="margin-top: 30px; padding: 15px; background: #f0fff4; border-left: 4px solid #38a169;">
                    <h4 style="margin-bottom: 10px; color: #276749;">PODSUMOWANIE ZAWODOW</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 11px;">
                        <div><strong>Zawodnicy w konkurencji:</strong> ${totalCompetitors}</div>
                        <div><strong>Zawodnicy PK:</strong> ${totalPK}</div>
                        <div><strong>Mezczyzni:</strong> ${finalResults.male.length}</div>
                        <div><strong>Kobiety:</strong> ${finalResults.female.length}</div>
                        <div><strong>Dyskwalifikacje:</strong> ${totalDQ}</div>
                        <div><strong>Laczna liczba biegow:</strong> ${series1Results.length + series2Results.length}</div>
                    </div>
                </div>
            `;

            return content;
        }

        // ==================== LIVE RESULTS (SECOND SCREEN) ====================

        function openLiveResults() {
            if (liveResultsWindow && !liveResultsWindow.closed) {
                liveResultsWindow.focus();
                updateLiveResults();
                return;
            }

            liveResultsWindow = window.open('', 'liveResults', 'width=1200,height=800');
            liveShowWomen = true;
            liveScrollDirection = 1;
            liveScrollPos = 0;

            liveResultsWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>OSF - Wyniki na zywo</title>
                    <meta charset="UTF-8">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Inter', 'Segoe UI', sans-serif;
                            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                            color: #e2e8f0;
                            height: 100vh;
                            overflow: hidden;
                            display: flex;
                            flex-direction: column;
                        }
                        .live-header {
                            background: linear-gradient(90deg, #1e293b 0%, #334155 50%, #1e293b 100%);
                            padding: 12px 40px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-bottom: 2px solid #334155;
                            flex-shrink: 0;
                        }
                        .live-header-left h1 { font-size: 20px; font-weight: 800; color: #f1f5f9; letter-spacing: 2px; text-transform: uppercase; }
                        .live-header-left p { font-size: 12px; color: #94a3b8; margin-top: 2px; }
                        .live-header-right { display: flex; align-items: center; gap: 16px; }
                        .live-indicator { display: flex; align-items: center; gap: 8px; background: rgba(239,68,68,0.15); padding: 6px 14px; border-radius: 20px; border: 1px solid rgba(239,68,68,0.3); }
                        .live-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: pulse 1.5s ease-in-out infinite; }
                        @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(239,68,68,0.7)} 50%{opacity:0.7;box-shadow:0 0 0 6px rgba(239,68,68,0)} }
                        .live-indicator span { font-size: 11px; font-weight: 700; color: #ef4444; text-transform: uppercase; letter-spacing: 2px; }
                        .toggle-btn { background: rgba(159,18,57,0.3); border: 1px solid rgba(159,18,57,0.5); color: #fecdd3; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 11px; font-weight: 600; font-family: inherit; transition: all 0.2s; }
                        .toggle-btn:hover { background: rgba(159,18,57,0.5); }
                        .toggle-btn.active { background: rgba(159,18,57,0.6); border-color: #be123c; }
                        .live-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 16px 24px; gap: 12px; }
                        .live-section { background: rgba(30,41,59,0.8); border-radius: 10px; border: 1px solid #334155; overflow: hidden; flex-shrink: 0; }
                        .live-section-scrollable { overflow: hidden; position: relative; }
                        .live-section-inner { transition: transform 0.5s ease; }
                        .live-section-header { padding: 8px 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; display: flex; justify-content: space-between; align-items: center; }
                        .live-section-male .live-section-header { background: linear-gradient(90deg, #1e40af, #1d4ed8); color: #bfdbfe; }
                        .live-section-female .live-section-header { background: linear-gradient(90deg, #9f1239, #be123c); color: #fecdd3; }
                        .live-section-header .count { font-size: 10px; opacity: 0.8; font-weight: 500; }
                        .live-table { width: 100%; border-collapse: collapse; }
                        .live-table thead th { background: rgba(15,23,42,0.6); padding: 5px 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; text-align: left; border-bottom: 1px solid #334155; }
                        .live-table tbody td { padding: 4px 12px; font-size: 13px; border-bottom: 1px solid rgba(51,65,85,0.5); line-height: 1.2; white-space: nowrap; }
                        .live-table tbody tr:hover { background: rgba(51,65,85,0.3); }
                        .live-table tbody tr.top-3 td:first-child { font-weight: 800; }
                        .live-table tbody tr.rank-1 { background: rgba(234,179,8,0.08); }
                        .live-table tbody tr.rank-1 td:first-child { color: #fbbf24; }
                        .live-table tbody tr.rank-2 { background: rgba(148,163,184,0.08); }
                        .live-table tbody tr.rank-2 td:first-child { color: #94a3b8; }
                        .live-table tbody tr.rank-3 { background: rgba(180,83,9,0.08); }
                        .live-table tbody tr.rank-3 td:first-child { color: #d97706; }
                        .live-pos { font-weight: 700; font-size: 14px; text-align: center; min-width: 32px; }
                        .live-name { font-weight: 600; color: #f1f5f9; }
                        .live-team { color: #94a3b8; font-size: 12px; }
                        .live-time { font-family: 'Courier New', monospace; font-size: 13px; color: #cbd5e0; }
                        .live-best { font-family: 'Courier New', monospace; font-weight: 700; font-size: 14px; color: #4ade80; }
                        .live-dq { color: #f87171; font-weight: 600; }
                        .live-no-data { text-align: center; padding: 40px; color: #64748b; font-style: italic; }
                        .live-timestamp { text-align: center; padding: 4px; font-size: 10px; color: #475569; background: #0f172a; flex-shrink: 0; }
                    </style>
                </head>
                <body>
                    <div class="live-header">
                        <div class="live-header-left">
                            <h1>OSF - Klasyfikacja</h1>
                            <p id="liveEventName"></p>
                        </div>
                        <div class="live-header-right">
                            <button class="toggle-btn active" id="toggleWomen" onclick="toggleWomenSection()">Kobiety</button>
                            <div class="live-indicator">
                                <div class="live-dot"></div>
                                <span>Na zywo</span>
                            </div>
                        </div>
                    </div>
                    <div class="live-content" id="liveContent">
                        <div class="live-no-data" style="padding: 80px;">Oczekiwanie na wyniki...</div>
                    </div>
                    <div class="live-timestamp" id="liveTimestamp"></div>
                    <script>
                        let showWomen = true;
                        function toggleWomenSection() {
                            showWomen = !showWomen;
                            const btn = document.getElementById('toggleWomen');
                            btn.classList.toggle('active', showWomen);
                            const femaleSection = document.getElementById('femaleLiveSection');
                            if (femaleSection) {
                                femaleSection.style.display = showWomen ? '' : 'none';
                            }
                            recalcMaleHeight();
                        }
                        function recalcMaleHeight() {
                            const maleSection = document.getElementById('maleLiveSection');
                            if (!maleSection) return;
                            const content = document.getElementById('liveContent');
                            const femaleSection = document.getElementById('femaleLiveSection');
                            const contentH = content.clientHeight - 24;
                            if (showWomen && femaleSection) {
                                const femaleH = femaleSection.offsetHeight;
                                maleSection.style.maxHeight = (contentH - femaleH - 12) + 'px';
                            } else {
                                maleSection.style.maxHeight = contentH + 'px';
                            }
                        }
                        // Auto-scroll for male section
                        let scrollDir = 1;
                        setInterval(() => {
                            const scrollable = document.getElementById('maleScrollable');
                            if (!scrollable) return;
                            const maxScroll = scrollable.scrollHeight - scrollable.clientHeight;
                            if (maxScroll <= 0) return;
                            scrollable.scrollTop += scrollDir * 1;
                            if (scrollable.scrollTop >= maxScroll) { scrollDir = -1; }
                            if (scrollable.scrollTop <= 0) { scrollDir = 1; }
                        }, 50);
                        window.addEventListener('resize', recalcMaleHeight);
                    <\/script>
                </body>
                </html>
            `);
            liveResultsWindow.document.close();

            updateLiveResults();
        }

        function updateLiveResults() {
            if (!liveResultsWindow || liveResultsWindow.closed) return;

            const finalResults = calculateFinalResults();
            const maleResults = finalResults.male.filter(r => r.bestTime || r.finalPosition === 'DQ');
            const femaleResults = finalResults.female.filter(r => r.bestTime || r.finalPosition === 'DQ');

            const eventName = document.getElementById('eventName').value;
            const eventLocation = document.getElementById('eventLocation').value;

            const liveEventNameEl = liveResultsWindow.document.getElementById('liveEventName');
            if (liveEventNameEl) {
                liveEventNameEl.textContent = [eventName, eventLocation].filter(Boolean).join(' | ');
            }

            const container = liveResultsWindow.document.getElementById('liveContent');
            if (!container) return;

            if (maleResults.length === 0 && femaleResults.length === 0) {
                container.innerHTML = '<div class="live-no-data" style="padding: 80px;">Oczekiwanie na wyniki...</div>';
                return;
            }

            const renderLiveTable = (results) => {
                if (results.length === 0) return '<div class="live-no-data">Brak wynikow</div>';
                return `
                    <table class="live-table">
                        <thead>
                            <tr>
                                <th style="width:36px; text-align:center;">#</th>
                                <th>Zawodnik</th>
                                <th>Jednostka</th>
                                <th style="text-align:center;">I Seria</th>
                                <th style="text-align:center;">II Seria</th>
                                <th style="text-align:center;">Wynik</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(r => {
                                const rankClass = r.finalPosition === 1 ? 'rank-1 top-3' : r.finalPosition === 2 ? 'rank-2 top-3' : r.finalPosition === 3 ? 'rank-3 top-3' : '';
                                return `
                                <tr class="${rankClass}">
                                    <td class="live-pos">${r.finalPosition === 'DQ' ? '<span class="live-dq">DQ</span>' : r.finalPosition}</td>
                                    <td class="live-name">${r.firstName} ${r.lastName}</td>
                                    <td class="live-team">${r.unitName}</td>
                                    <td class="live-time" style="text-align:center;">${r.series1 && r.series1.time ? (r.series1.status !== 'OK' ? `<span class="live-dq">${r.series1.status}</span>` : r.series1.time) : '-'}</td>
                                    <td class="live-time" style="text-align:center;">${r.series2 && r.series2.time ? (r.series2.status !== 'OK' ? `<span class="live-dq">${r.series2.status}</span>` : r.series2.time) : '-'}</td>
                                    <td style="text-align:center;" class="live-best">${r.displayResult}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            };

            // Check if women are currently shown
            const showWomen = liveResultsWindow.showWomen !== undefined ? liveResultsWindow.showWomen : true;

            let html = '';

            if (maleResults.length > 0) {
                html += `
                <div class="live-section live-section-male" id="maleLiveSection" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <div class="live-section-header">
                        <span>Mezczyzni</span>
                        <span class="count">${maleResults.length} zawodnikow</span>
                    </div>
                    <div id="maleScrollable" style="overflow: hidden; flex: 1;">
                        ${renderLiveTable(maleResults)}
                    </div>
                </div>`;
            }

            if (femaleResults.length > 0) {
                html += `
                <div class="live-section live-section-female" id="femaleLiveSection" style="flex-shrink: 0; ${showWomen ? '' : 'display:none;'}">
                    <div class="live-section-header">
                        <span>Kobiety</span>
                        <span class="count">${femaleResults.length} zawodniczek</span>
                    </div>
                    ${renderLiveTable(femaleResults)}
                </div>`;
            }

            container.innerHTML = html;

            // Recalculate male section height
            setTimeout(() => {
                if (liveResultsWindow && !liveResultsWindow.closed && liveResultsWindow.recalcMaleHeight) {
                    liveResultsWindow.recalcMaleHeight();
                }
            }, 50);

            const timestamp = liveResultsWindow.document.getElementById('liveTimestamp');
            if (timestamp) {
                timestamp.textContent = 'Ostatnia aktualizacja: ' + new Date().toLocaleTimeString('pl-PL');
            }
        }

        // ==================== CSV IMPORT ====================

        function toggleInstructions() {
            const panel = document.getElementById('instructionsPanel');
            const toggle = document.getElementById('instrToggle');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                toggle.textContent = '(kliknij aby zwinac)';
            } else {
                panel.style.display = 'none';
                toggle.textContent = '(kliknij aby rozwinac)';
            }
        }

        function parseCsvLine(line) {
            const sep = line.includes(';') ? ';' : ',';
            return line.split(sep).map(p => p.trim());
        }

        function isHeaderLine(line) {
            const lower = line.toLowerCase();
            return lower.includes('imie') || lower.includes('nazwisko') || lower.includes('name')
                || lower.includes('druzyn') || lower.includes('jednostk') || lower.includes('lewy')
                || lower.includes('nr_') || lower.includes('numer');
        }

        function importCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const statusDiv = document.getElementById('csvImportStatus');

            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.innerHTML = '<span style="color: #e53e3e;">Wybierz plik CSV</span>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(l => l.trim());

                let imported = 0;
                let skipped = 0;
                let unitsCreated = 0;
                let errors = [];

                let startLine = 0;
                if (lines.length > 0 && isHeaderLine(lines[0])) startLine = 1;

                for (let i = startLine; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = parseCsvLine(line);

                    // Format: nr_druzyny;nazwa_druzyny;nr_zawodnika;imie;nazwisko;plec;stopien
                    if (parts.length < 6) {
                        errors.push(`Wiersz ${i + 1}: za malo kolumn (${parts.length}), potrzeba min 6`);
                        skipped++;
                        continue;
                    }

                    const unitNumber = parseInt(parts[0]);
                    const unitName = parts[1];
                    const position = parseInt(parts[2]);
                    const firstName = parts[3];
                    const lastName = parts[4];
                    const gender = parts[5].toUpperCase();
                    const rank = parts.length > 6 ? parts[6] : '';

                    if (!unitNumber || !unitName) {
                        errors.push(`Wiersz ${i + 1}: brakuje numeru lub nazwy druzyny`);
                        skipped++;
                        continue;
                    }
                    if (!position || !firstName || !lastName) {
                        errors.push(`Wiersz ${i + 1}: brakuje nr zawodnika, imienia lub nazwiska`);
                        skipped++;
                        continue;
                    }
                    if (gender !== 'M' && gender !== 'K') {
                        errors.push(`Wiersz ${i + 1}: plec musi byc M lub K (podano: ${parts[5]})`);
                        skipped++;
                        continue;
                    }

                    // Find or create unit by number
                    let unit = units.find(u => u.number === unitNumber);
                    if (!unit) {
                        // Check by name too
                        unit = units.find(u => u.name.toLowerCase() === unitName.toLowerCase());
                        if (unit) {
                            unit.number = unitNumber;
                        } else {
                            unit = {
                                id: Date.now() + Math.random(),
                                name: unitName,
                                number: unitNumber
                            };
                            units.push(unit);
                            unitsCreated++;
                        }
                    }

                    // Check duplicate position
                    const existingPos = competitors.find(c => c.unitId === unit.id && c.position === position);
                    if (existingPos) {
                        errors.push(`Wiersz ${i + 1}: pozycja ${position} w druzynie ${unitName} juz zajeta`);
                        skipped++;
                        continue;
                    }

                    const unitCompetitors = competitors.filter(c => c.unitId === unit.id);
                    if (unitCompetitors.length >= 12) {
                        errors.push(`Wiersz ${i + 1}: druzyna ${unitName} ma juz 12 zawodnikow`);
                        skipped++;
                        continue;
                    }

                    competitors.push({
                        id: Date.now() + Math.random(),
                        firstName: firstName,
                        lastName: lastName,
                        unitId: unit.id,
                        gender: gender,
                        isPK: false,
                        position: position,
                        rank: rank || ''
                    });

                    imported++;
                }

                updateUnitsTable();
                updateCompetitorsList();
                updateCompetitorUnitSelect();
                updateEditModalsSelects();
                scheduleAutoSave();

                let statusMsg = `<span style="color: #38a169;">Zaimportowano: ${imported} zawodnikow`;
                if (unitsCreated > 0) statusMsg += `, utworzono ${unitsCreated} druzyn`;
                statusMsg += '</span>';
                if (skipped > 0) {
                    statusMsg += `<br><span style="color: #d69e2e;">Pominieto: ${skipped}</span>`;
                }
                if (errors.length > 0) {
                    statusMsg += '<br><small style="color: #e53e3e;">' + errors.slice(0, 5).join('<br>') + '</small>';
                    if (errors.length > 5) statusMsg += `<br><small style="color: #e53e3e;">...i ${errors.length - 5} wiecej</small>`;
                }
                statusDiv.innerHTML = statusMsg;
                fileInput.value = '';
            };

            reader.readAsText(fileInput.files[0], 'UTF-8');
        }

        function importSchemaCSV() {
            const fileInput = document.getElementById('csvSchemaInput');
            const statusDiv = document.getElementById('schemaImportStatus');

            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.innerHTML = '<span style="color: #e53e3e;">Wybierz plik CSV</span>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(l => l.trim());

                let imported = 0;
                let errors = [];

                let startLine = 0;
                if (lines.length > 0 && isHeaderLine(lines[0])) startLine = 1;

                for (let i = startLine; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = parseCsvLine(line);

                    if (parts.length < 4) {
                        errors.push(`Wiersz ${i + 1}: za malo kolumn`);
                        continue;
                    }

                    const leftUnitNum = parts[0] ? parseInt(parts[0]) : null;
                    const leftPos = parts[1] ? parseInt(parts[1]) : null;
                    const rightUnitNum = parts[2] ? parseInt(parts[2]) : null;
                    const rightPos = parts[3] ? parseInt(parts[3]) : null;

                    if (!leftUnitNum && !rightUnitNum) {
                        errors.push(`Wiersz ${i + 1}: oba tory puste`);
                        continue;
                    }

                    const race = {
                        id: Date.now() + schema.length + Math.random(),
                        leftLane: null,
                        rightLane: null
                    };

                    if (leftUnitNum && leftPos) {
                        const unit = units.find(u => u.number === leftUnitNum);
                        if (!unit) {
                            errors.push(`Wiersz ${i + 1}: druzyna nr ${leftUnitNum} nie istnieje`);
                            continue;
                        }
                        const comp = competitors.find(c => c.unitId === unit.id && c.position === leftPos && !c.isPK);
                        if (!comp) {
                            errors.push(`Wiersz ${i + 1}: zawodnik ${leftUnitNum}/${leftPos} nie istnieje`);
                            continue;
                        }
                        race.leftLane = {
                            unitNumber: leftUnitNum,
                            position: leftPos,
                            competitorId: comp.id,
                            name: `${comp.firstName} ${comp.lastName}`
                        };
                    }

                    if (rightUnitNum && rightPos) {
                        const unit = units.find(u => u.number === rightUnitNum);
                        if (!unit) {
                            errors.push(`Wiersz ${i + 1}: druzyna nr ${rightUnitNum} nie istnieje`);
                            continue;
                        }
                        const comp = competitors.find(c => c.unitId === unit.id && c.position === rightPos && !c.isPK);
                        if (!comp) {
                            errors.push(`Wiersz ${i + 1}: zawodnik ${rightUnitNum}/${rightPos} nie istnieje`);
                            continue;
                        }
                        race.rightLane = {
                            unitNumber: rightUnitNum,
                            position: rightPos,
                            competitorId: comp.id,
                            name: `${comp.firstName} ${comp.lastName}`
                        };
                    }

                    schema.push(race);
                    imported++;
                }

                updateSchemaList();
                scheduleAutoSave();

                let statusMsg = `<span style="color: #38a169;">Zaimportowano: ${imported} biegow</span>`;
                if (errors.length > 0) {
                    statusMsg += '<br><small style="color: #e53e3e;">' + errors.slice(0, 5).join('<br>') + '</small>';
                    if (errors.length > 5) statusMsg += `<br><small style="color: #e53e3e;">...i ${errors.length - 5} wiecej</small>`;
                }
                statusDiv.innerHTML = statusMsg;
                fileInput.value = '';
            };

            reader.readAsText(fileInput.files[0], 'UTF-8');
        }

        function downloadDemoCSV(type) {
            let content = '';
            let filename = '';

            if (type === 'zawodnicy') {
                filename = 'demo_zawodnicy.csv';
                content = 'nr_druzyny;nazwa_druzyny;nr_zawodnika;imie;nazwisko;plec;stopien\n';
                content += '1;OSP Powidz;1;Jan;Kowalski;M;ml. ogn.\n';
                content += '1;OSP Powidz;2;Piotr;Nowak;M;ogn.\n';
                content += '1;OSP Powidz;3;Adam;Wisniewski;M;str.\n';
                content += '1;OSP Powidz;4;Anna;Kowalczyk;K;\n';
                content += '1;OSP Powidz;5;Maria;Kaminska;K;\n';
                content += '2;OSP Slupca;1;Tomasz;Lewandowski;M;asp.\n';
                content += '2;OSP Slupca;2;Marek;Wojcik;M;str.\n';
                content += '2;OSP Slupca;3;Kamil;Zielinski;M;\n';
                content += '2;OSP Slupca;4;Ewa;Szymanska;K;\n';
                content += '3;OSP Koszalin;1;Robert;Dabrowski;M;ogn.\n';
                content += '3;OSP Koszalin;2;Lukasz;Kozlowski;M;\n';
                content += '3;OSP Koszalin;3;Monika;Jankowska;K;\n';
                content += '4;OSP Zdunska Wola;1;Pawel;Mazur;M;ml. ogn.\n';
                content += '4;OSP Zdunska Wola;2;Krzysztof;Krawczyk;M;\n';
                content += '4;OSP Zdunska Wola;3;Agnieszka;Wojciechowska;K;\n';
            } else if (type === 'schemat') {
                filename = 'demo_schemat.csv';
                content = 'lewy_druzyna;lewy_zawodnik;prawy_druzyna;prawy_zawodnik\n';
                content += '1;1;2;1\n';
                content += '1;2;2;2\n';
                content += '1;3;2;3\n';
                content += '1;4;2;4\n';
                content += '1;5;;\n';
                content += '3;1;4;1\n';
                content += '3;2;4;2\n';
                content += '3;3;4;3\n';
            }

            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== SAVE / LOAD ====================

        function saveAllData() {
            const data = {
                eventName: document.getElementById('eventName').value,
                eventLocation: document.getElementById('eventLocation').value,
                units: units,
                competitors: competitors,
                schema: schema,
                series1Results: series1Results,
                series2Results: series2Results,
                savedAt: new Date().toLocaleString('pl-PL')
            };

            try {
                localStorage.setItem('osf_data', JSON.stringify(data));
                const statusEl = document.getElementById('saveStatus');
                statusEl.textContent = 'Zapisano! (' + data.savedAt + ')';
                setTimeout(() => { statusEl.textContent = ''; }, 5000);
            } catch (e) {
                alert('Blad zapisu: ' + e.message);
            }
        }

        function loadAllData() {
            try {
                const raw = localStorage.getItem('osf_data');
                if (!raw) {
                    alert('Brak zapisanych danych');
                    return;
                }

                const data = JSON.parse(raw);

                if (!confirm('Wczytac dane z: ' + (data.savedAt || 'nieznana data') + '? Obecne dane zostana nadpisane.')) {
                    return;
                }

                document.getElementById('eventName').value = data.eventName || '';
                document.getElementById('eventLocation').value = data.eventLocation || '';
                units = data.units || [];
                competitors = data.competitors || [];
                schema = data.schema || [];
                series1Results = data.series1Results || [];
                series2Results = data.series2Results || [];

                updateUnitsTable();
                updateCompetitorUnitSelect();
                updateCompetitorsList();
                updateEditModalsSelects();

                if (schema.length > 0) updateSchemaList();
                if (series1Results.length > 0) updateSeries1List();
                if (series2Results.length > 0) updateSeries2List();

                const statusEl = document.getElementById('saveStatus');
                statusEl.textContent = 'Wczytano dane z: ' + (data.savedAt || '');
                setTimeout(() => { statusEl.textContent = ''; }, 5000);
            } catch (e) {
                alert('Blad wczytywania: ' + e.message);
            }
        }

        function clearAllData() {
            if (!confirm('Czy na pewno wyczyscic WSZYSTKIE dane? Ta operacja jest nieodwracalna!')) return;
            if (!confirm('Na pewno? Wszystkie jednostki, zawodnicy, schematy i wyniki zostana usuniete.')) return;

            localStorage.removeItem('osf_data');
            units = [];
            competitors = [];
            schema = [];
            series1Results = [];
            series2Results = [];

            document.getElementById('eventName').value = '';
            document.getElementById('eventLocation').value = '';

            updateUnitsTable();
            updateCompetitorUnitSelect();
            updateCompetitorsList();
            updateEditModalsSelects();

            document.getElementById('schemaList').innerHTML = '<p class="text-center" style="color: #718096;">Brak biegow w schemacie</p>';
            document.getElementById('startSeries1Btn').style.display = 'none';
            document.getElementById('series1List').innerHTML = '';
            document.getElementById('startSeries2Btn').style.display = 'none';
            document.getElementById('series2List').innerHTML = '';
            document.getElementById('generateResultsBtn').style.display = 'none';
            document.getElementById('finalResultsList').innerHTML = '';
        }

        // Auto-save on any change (debounced)
        let autoSaveTimer = null;
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const data = {
                    eventName: document.getElementById('eventName').value,
                    eventLocation: document.getElementById('eventLocation').value,
                    units: units,
                    competitors: competitors,
                    schema: schema,
                    series1Results: series1Results,
                    series2Results: series2Results,
                    savedAt: new Date().toLocaleString('pl-PL')
                };
                try { localStorage.setItem('osf_data', JSON.stringify(data)); } catch(e) {}
            }, 2000);
        }

        // Hook auto-save into result updates
        const origUpdateResult = updateResult;
        updateResult = function(series, raceId, lane, field, value) {
            origUpdateResult(series, raceId, lane, field, value);
            scheduleAutoSave();
        };

        // ==================== EVENT LISTENERS ====================

        document.getElementById('editRaceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('editRaceModal').classList.contains('active')) {
                closeEditModal();
            }
        });

        // Auto-load on startup
        function autoLoadOnStartup() {
            try {
                const raw = localStorage.getItem('osf_data');
                if (raw) {
                    const data = JSON.parse(raw);
                    document.getElementById('eventName').value = data.eventName || '';
                    document.getElementById('eventLocation').value = data.eventLocation || '';
                    units = data.units || [];
                    competitors = data.competitors || [];
                    schema = data.schema || [];
                    series1Results = data.series1Results || [];
                    series2Results = data.series2Results || [];
                }
            } catch(e) {}
        }

        // Initialize
        autoLoadOnStartup();
        updateUnitsTable();
        updateCompetitorUnitSelect();
        updateCompetitorsList();
        updateEditModalsSelects();
        if (schema.length > 0) updateSchemaList();
        if (series1Results.length > 0) updateSeries1List();
        if (series2Results.length > 0) updateSeries2List();

        setTimeout(() => {
            updateQuickPreview();
        }, 100);
    </script>
</body>
</html>
