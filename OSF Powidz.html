<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSF - O≈õrodek Sprawno≈õci Fizycznej</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .nav { display: flex; background: #e9ecef; border-bottom: 1px solid #ddd; }
        .nav-btn { flex: 1; padding: 15px; background: #e9ecef; border: none; cursor: pointer; font-size: 16px; font-weight: 500; color: #495057; transition: all 0.3s; }
        .nav-btn:hover { background: #dee2e6; color: #343a40; }
        .nav-btn.active { background: white; border-bottom: 3px solid #667eea; color: #667eea; font-weight: bold; }
        .content { padding: 20px; min-height: 500px; }
        .section { display: none; }
        .section.active { display: block; }
        input, select, button, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        button { background: #667eea; color: white; border: none; cursor: pointer; transition: all 0.3s; }
        button:hover { background: #5a6fd8; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; font-weight: bold; }
        .pk-row { background: #fff3cd; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .text-center { text-align: center; }
        .text-success { color: #28a745; }
        .text-danger { color: #dc3545; }
        .text-warning { color: #ffc107; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; }
        .lane-selector { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        .time-input { width: 80px; }
        .status-select { width: 70px; }
        @media print { .nav, button:not(.print-only) { display: none !important; } .container { box-shadow: none; } .content { padding: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ OSF - O≈õrodek Sprawno≈õci Fizycznej</h1>
            <p>System zarzƒÖdzania zawodami sportowymi</p>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" onclick="showSection('units')">Jednostki</button>
            <button class="nav-btn" onclick="showSection('competitors')">Zawodnicy</button>
            <button class="nav-btn" onclick="showSection('schema')">Schemat</button>
            <button class="nav-btn" onclick="showSection('series1')">I Seria</button>
            <button class="nav-btn" onclick="showSection('series2')">II Seria</button>
            <button class="nav-btn" onclick="showSection('results')">Wyniki</button>
        </div>
        
        <div class="content">
            <div class="card">
                <h3>Informacje o zawodach</h3>
                <div class="flex">
                    <input type="text" id="eventName" placeholder="Nazwa zawod√≥w" style="flex: 1;">
                    <input type="text" id="eventLocation" placeholder="Miejscowo≈õƒá" style="flex: 1;">
                </div>
            </div>
            
            <!-- Jednostki -->
            <div id="units" class="section active">
                <h2>ZarzƒÖdzanie Jednostkami</h2>
                <div class="card">
                    <h3>Dodaj Jednostkƒô</h3>
                    <div class="flex">
                        <input type="text" id="unitName" placeholder="Nazwa jednostki" style="flex: 1;">
                        <input type="number" id="unitNumber" placeholder="Numer" min="1" max="10">
                        <button onclick="addUnit()" class="btn-success">Dodaj</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Lista Jednostek</h3>
                    <table>
                        <thead>
                            <tr><th>Nazwa</th><th>Numer</th><th>Zawodnicy</th><th>Akcje</th></tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <tr><td colspan="4" class="text-center">Brak jednostek</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Zawodnicy -->
            <div id="competitors" class="section">
                <h2>ZarzƒÖdzanie Zawodnikami</h2>
                <div class="card">
                    <h3>Dodaj Zawodnika</h3>
                    <div class="grid">
                        <input type="text" id="competitorFirstName" placeholder="Imiƒô">
                        <input type="text" id="competitorLastName" placeholder="Nazwisko">
                        <select id="competitorUnit">
                            <option value="">Wybierz jednostkƒô</option>
                        </select>
                        <select id="competitorGender">
                            <option value="M">Mƒô≈ºczyzna</option>
                            <option value="K">Kobieta</option>
                        </select>
                    </div>
                    <div class="flex mt-20">
                        <label><input type="checkbox" id="competitorPK"> PK (Poza KonkurencjƒÖ)</label>
                        <button onclick="addCompetitor()" class="btn-success">Dodaj Zawodnika</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Lista Zawodnik√≥w</h3>
                    <div id="competitorsList"></div>
                </div>
            </div>
            
            <!-- Schemat -->
            <div id="schema" class="section">
                <h2>Schemat Bieg√≥w - I Seria</h2>
                <div class="card">
                    <div class="flex">
                        <button onclick="generateAutoSchema()" class="btn-success">Generuj Automatycznie</button>
                        <button onclick="addManualRace()">Dodaj Bieg Rƒôcznie</button>
                        <button onclick="clearSchema()" class="btn-danger">Wyczy≈õƒá</button>
                        <button onclick="printSection('schema')" class="btn-warning">üñ®Ô∏è Drukuj</button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Szybkie Dodawanie Biegu</h4>
                        <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                            <div>
                                <label>Lewy - Jednostka:</label>
                                <select id="quickLeftUnit">
                                    <option value="">-</option>
                                </select>
                            </div>
                            <div>
                                <label>Pozycja:</label>
                                <select id="quickLeftPos">
                                    <option value="">-</option>
                                </select>
                            </div>
                            <div>
                                <label>Prawy - Jednostka:</label>
                                <select id="quickRightUnit">
                                    <option value="">-</option>
                                </select>
                            </div>
                            <div>
                                <label>Pozycja:</label>
                                <select id="quickRightPos">
                                    <option value="">-</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex" style="margin-top: 15px;">
                            <span id="quickPreview" style="flex: 1; font-style: italic; color: #666;"></span>
                            <button onclick="addQuickRace()" class="btn-success">Dodaj Bieg</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Lista Bieg√≥w</h3>
                    <div id="schemaList"></div>
                    <button id="startSeries1Btn" onclick="startSeries1()" class="btn-success" style="display:none; margin-top: 20px;">
                        üöÄ Rozpocznij I Seriƒô
                    </button>
                </div>
            </div>
            
            <!-- I Seria -->
            <div id="series1" class="section">
                <h2>I Seria - Wprowadzanie Wynik√≥w</h2>
                <div class="card">
                    <button onclick="printSection('series1')" class="btn-warning">üñ®Ô∏è Drukuj</button>
                    <h3>Lista Startowa I Serii</h3>
                    <div id="series1List"></div>
                    <button id="startSeries2Btn" onclick="startSeries2()" class="btn-success" style="display:none; margin-top: 20px;">
                        üîÑ Generuj II Seriƒô
                    </button>
                </div>
            </div>
            
            <!-- II Seria -->
            <div id="series2" class="section">
                <h2>II Seria - Wyniki</h2>
                <div class="card">
                    <button onclick="printSection('series2')" class="btn-warning">üñ®Ô∏è Drukuj</button>
                    <p><strong>Zasada:</strong> Zawodnicy zmieniajƒÖ tory (lewy‚Üîprawy). Kolejno≈õƒá: DDF/DSQ ‚Üí najgorsze czasy ‚Üí najlepsze czasy</p>
                    <div id="series2List"></div>
                    <button id="generateResultsBtn" onclick="generateFinalResults()" class="btn-success" style="display:none; margin-top: 20px;">
                        üèÜ Generuj Wyniki Ko≈Ñcowe
                    </button>
                </div>
            </div>
            
            <!-- Wyniki -->
            <div id="results" class="section">
                <h2>Wyniki Ko≈Ñcowe</h2>
                <div class="card">
                    <button onclick="printSection('results')" class="btn-warning">üñ®Ô∏è Drukuj</button>
                    <div class="flex mb-20">
                        <button onclick="showResults('all')" class="nav-btn active" id="resultsAllBtn">Wszyscy</button>
                        <button onclick="showResults('M')" class="nav-btn" id="resultsMBtn">Mƒô≈ºczy≈∫ni</button>
                        <button onclick="showResults('K')" class="nav-btn" id="resultsKBtn">Kobiety</button>
                    </div>
                    <div id="finalResultsList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal edycji -->
    <div id="editRaceModal" class="modal">
        <div class="modal-content">
            <h3>Edytuj Bieg</h3>
            <div class="lane-selector">
                <label>Tor lewy:</label>
                <select id="editLeftUnit"><option value="">Brak</option></select>
                <span>/</span>
                <select id="editLeftPosition"><option value="">-</option></select>
                <span id="editLeftName"></span>
            </div>
            <div class="lane-selector">
                <label>Tor prawy:</label>
                <select id="editRightUnit"><option value="">Brak</option></select>
                <span>/</span>
                <select id="editRightPosition"><option value="">-</option></select>
                <span id="editRightName"></span>
            </div>
            <div class="flex mt-20">
                <button onclick="saveRaceEdit()" class="btn-success">Zapisz</button>
                <button onclick="closeEditModal()" class="btn-secondary">Anuluj</button>
            </div>
        </div>
    </div>

    <script>
        let units = [];
        let competitors = [];
        let schema = [];
        let series1Results = [];
        let series2Results = [];
        let currentResultsView = 'all';
        let editingRaceId = null;
        
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === '-') return 9999;
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            }
            return 9999;
        }
        
        function addUnit() {
            const name = document.getElementById('unitName').value.trim();
            const number = document.getElementById('unitNumber').value;
            
            if (!name) {
                alert('Wprowad≈∫ nazwƒô jednostki');
                return;
            }
            
            if (number && units.find(u => u.number == number)) {
                alert('Ten numer jest ju≈º zajƒôty');
                return;
            }
            
            units.push({
                id: Date.now(),
                name: name,
                number: number ? parseInt(number) : null
            });
            
            document.getElementById('unitName').value = '';
            document.getElementById('unitNumber').value = '';
            
            updateUnitsTable();
            updateCompetitorUnitSelect();
            updateEditModalsSelects();
        }
        
        function updateUnitsTable() {
            const tbody = document.getElementById('unitsTableBody');
            
            if (units.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Brak jednostek</td></tr>';
                return;
            }
            
            tbody.innerHTML = units.map(unit => {
                const competitorCount = competitors.filter(c => c.unitId === unit.id).length;
                return `
                    <tr>
                        <td>${unit.name}</td>
                        <td>
                            <input type="number" value="${unit.number || ''}" 
                                   onchange="updateUnitNumber(${unit.id}, this.value)"
                                   min="1" max="10" style="width: 60px;">
                        </td>
                        <td>${competitorCount}/12</td>
                        <td>
                            <button onclick="deleteUnit(${unit.id})" class="btn-danger">Usu≈Ñ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateUnitNumber(unitId, number) {
            const unit = units.find(u => u.id === unitId);
            if (unit) {
                if (number && units.find(u => u.id !== unitId && u.number == number)) {
                    alert('Ten numer jest ju≈º zajƒôty');
                    updateUnitsTable();
                    return;
                }
                unit.number = number ? parseInt(number) : null;
                updateEditModalsSelects();
            }
        }
        
        function deleteUnit(unitId) {
            if (confirm('Czy na pewno usunƒÖƒá jednostkƒô? ZostanƒÖ usuniƒôci r√≥wnie≈º jej zawodnicy.')) {
                units = units.filter(u => u.id !== unitId);
                competitors = competitors.filter(c => c.unitId !== unitId);
                updateUnitsTable();
                updateCompetitorsList();
                updateCompetitorUnitSelect();
                updateEditModalsSelects();
            }
        }
        
        function updateCompetitorUnitSelect() {
            const select = document.getElementById('competitorUnit');
            select.innerHTML = '<option value="">Wybierz jednostkƒô</option>';
            units.forEach(unit => {
                select.innerHTML += `<option value="${unit.id}">${unit.name}${unit.number ? ` (${unit.number})` : ''}</option>`;
            });
        }
        
        function addCompetitor() {
            const firstName = document.getElementById('competitorFirstName').value.trim();
            const lastName = document.getElementById('competitorLastName').value.trim();
            const unitId = document.getElementById('competitorUnit').value;
            const gender = document.getElementById('competitorGender').value;
            const isPK = document.getElementById('competitorPK').checked;
            
            if (!firstName || !lastName || !unitId) {
                alert('Wype≈Çnij wszystkie pola');
                return;
            }
            
            const unitCompetitors = competitors.filter(c => c.unitId == unitId);
            
            if (unitCompetitors.length >= 12) {
                alert('Maksymalnie 12 zawodnik√≥w na jednostkƒô');
                return;
            }
            
            competitors.push({
                id: Date.now(),
                firstName: firstName,
                lastName: lastName,
                unitId: parseInt(unitId),
                gender: gender,
                isPK: isPK,
                position: unitCompetitors.length + 1
            });
            
            document.getElementById('competitorFirstName').value = '';
            document.getElementById('competitorLastName').value = '';
            document.getElementById('competitorPK').checked = false;
            
            updateCompetitorsList();
            updateUnitsTable();
        }
        
        function updateCompetitorsList() {
            const container = document.getElementById('competitorsList');
            
            if (competitors.length === 0) {
                container.innerHTML = '<p class="text-center">Brak zawodnik√≥w</p>';
                return;
            }
            
            const competitorsByUnit = {};
            competitors.forEach(competitor => {
                if (!competitorsByUnit[competitor.unitId]) {
                    competitorsByUnit[competitor.unitId] = [];
                }
                competitorsByUnit[competitor.unitId].push(competitor);
            });
            
            container.innerHTML = Object.keys(competitorsByUnit).map(unitId => {
                const unit = units.find(u => u.id == unitId);
                const unitCompetitors = competitorsByUnit[unitId].sort((a, b) => a.position - b.position);
                
                return `
                    <div class="card">
                        <h4>${unit.name}${unit.number ? ` (${unit.number})` : ''}</h4>
                        <table>
                            <thead>
                                <tr><th>Lp.</th><th>Imiƒô i Nazwisko</th><th>P≈Çeƒá</th><th>Status</th><th>Kod</th><th>Akcje</th></tr>
                            </thead>
                            <tbody>
                                ${unitCompetitors.map(competitor => `
                                    <tr class="${competitor.isPK ? 'pk-row' : ''}">
                                        <td>${competitor.position}</td>
                                        <td>${competitor.firstName} ${competitor.lastName}</td>
                                        <td>${competitor.gender}</td>
                                        <td>${competitor.isPK ? '<span class="text-warning">PK</span>' : '<span class="text-success">W konkurencji</span>'}</td>
                                        <td>${unit.number ? `${unit.number}/${competitor.position}` : '-'}</td>
                                        <td>
                                            <button onclick="moveCompetitor(${competitor.id}, 'up')">‚Üë</button>
                                            <button onclick="moveCompetitor(${competitor.id}, 'down')">‚Üì</button>
                                            <button onclick="deleteCompetitor(${competitor.id})" class="btn-danger">‚úï</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
        }
        
        function moveCompetitor(competitorId, direction) {
            const competitor = competitors.find(c => c.id === competitorId);
            const unitCompetitors = competitors.filter(c => c.unitId === competitor.unitId).sort((a, b) => a.position - b.position);
            const currentIndex = unitCompetitors.findIndex(c => c.id === competitorId);
            
            if (direction === 'up' && currentIndex > 0) {
                const swapWith = unitCompetitors[currentIndex - 1];
                const tempPosition = competitor.position;
                competitor.position = swapWith.position;
                swapWith.position = tempPosition;
            } else if (direction === 'down' && currentIndex < unitCompetitors.length - 1) {
                const swapWith = unitCompetitors[currentIndex + 1];
                const tempPosition = competitor.position;
                competitor.position = swapWith.position;
                swapWith.position = tempPosition;
            }
            
            updateCompetitorsList();
        }
        
        function deleteCompetitor(competitorId) {
            if (confirm('Czy na pewno usunƒÖƒá zawodnika?')) {
                const competitor = competitors.find(c => c.id === competitorId);
                competitors = competitors.filter(c => c.id !== competitorId);
                
                const unitCompetitors = competitors.filter(c => c.unitId === competitor.unitId).sort((a, b) => a.position - b.position);
                unitCompetitors.forEach((comp, index) => {
                    comp.position = index + 1;
                });
                
                updateCompetitorsList();
                updateUnitsTable();
            }
        }
        
        function generateAutoSchema() {
            const numberedUnits = units.filter(u => u.number !== null).sort((a, b) => a.number - b.number);
            
            if (numberedUnits.length < 2) {
                alert('Potrzebujesz co najmniej 2 jednostki z numerami');
                return;
            }
            
            schema = [];
            
            for (let i = 0; i < numberedUnits.length; i += 2) {
                if (i + 1 < numberedUnits.length) {
                    const unit1 = numberedUnits[i];
                    const unit2 = numberedUnits[i + 1];
                    
                    const competitors1 = competitors.filter(c => c.unitId === unit1.id && !c.isPK).sort((a, b) => a.position - b.position);
                    const competitors2 = competitors.filter(c => c.unitId === unit2.id && !c.isPK).sort((a, b) => a.position - b.position);
                    
                    const maxLength = Math.max(competitors1.length, competitors2.length);
                    
                    for (let j = 0; j < maxLength; j++) {
                        const comp1 = competitors1[j];
                        const comp2 = competitors2[j];
                        
                        if (comp1 || comp2) {
                            schema.push({
                                id: Date.now() + schema.length,
                                leftLane: comp1 ? {
                                    unitNumber: unit1.number,
                                    position: comp1.position,
                                    competitorId: comp1.id,
                                    name: `${comp1.firstName} ${comp1.lastName}`
                                } : null,
                                rightLane: comp2 ? {
                                    unitNumber: unit2.number,
                                    position: comp2.position,
                                    competitorId: comp2.id,
                                    name: `${comp2.firstName} ${comp2.lastName}`
                                } : null
                            });
                        }
                    }
                }
            }
            
            updateSchemaList();
        }
        
        function addManualRace() {
            const race = {
                id: Date.now(),
                leftLane: null,
                rightLane: null
            };
            
            schema.push(race);
            updateSchemaList();
            
            setTimeout(() => {
                editRace(race.id);
            }, 100);
        }
        
        function quickAddRace(leftUnit, leftPos, rightUnit, rightPos) {
            const race = {
                id: Date.now(),
                leftLane: null,
                rightLane: null
            };
            
            if (leftUnit && leftPos) {
                const unit = units.find(u => u.number == leftUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == leftPos && !c.isPK);
                if (competitor) {
                    race.leftLane = {
                        unitNumber: parseInt(leftUnit),
                        position: parseInt(leftPos),
                        competitorId: competitor.id,
                        name: `${competitor.firstName} ${competitor.lastName}`
                    };
                }
            }
            
            if (rightUnit && rightPos) {
                const unit = units.find(u => u.number == rightUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == rightPos && !c.isPK);
                if (competitor) {
                    race.rightLane = {
                        unitNumber: parseInt(rightUnit),
                        position: parseInt(rightPos),
                        competitorId: competitor.id,
                        name: `${competitor.firstName} ${competitor.lastName}`
                    };
                }
            }
            
            schema.push(race);
            updateSchemaList();
        }
        
        function clearSchema() {
            if (confirm('Czy na pewno wyczy≈õciƒá ca≈Çy schemat?')) {
                schema = [];
                updateSchemaList();
            }
        }
        
        function updateSchemaList() {
            const container = document.getElementById('schemaList');
            
            if (schema.length === 0) {
                container.innerHTML = '<p class="text-center">Brak bieg√≥w w schemacie</p>';
                document.getElementById('startSeries1Btn').style.display = 'none';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr><th>Bieg</th><th>Tor Lewy</th><th>Tor Prawy</th><th>Akcje</th></tr>
                    </thead>
                    <tbody>
                        ${schema.map((race, index) => `
                            <tr>
                                <td><strong>${index + 1}</strong></td>
                                <td>${race.leftLane ? `${race.leftLane.unitNumber}/${race.leftLane.position} - ${race.leftLane.name}` : '-'}</td>
                                <td>${race.rightLane ? `${race.rightLane.unitNumber}/${race.rightLane.position} - ${race.rightLane.name}` : '-'}</td>
                                <td>
                                    <button onclick="editRace(${race.id})">Edytuj</button>
                                    <button onclick="deleteRace(${race.id})" class="btn-danger">Usu≈Ñ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('startSeries1Btn').style.display = 'block';
        }
        
        function deleteRace(raceId) {
            if (confirm('Czy na pewno usunƒÖƒá ten bieg?')) {
                schema = schema.filter(r => r.id !== raceId);
                updateSchemaList();
            }
        }
        
        function editRace(raceId) {
            editingRaceId = raceId;
            const race = schema.find(r => r.id === raceId);
            
            updateEditModalsSelects();
            
            document.getElementById('editLeftUnit').value = race.leftLane ? race.leftLane.unitNumber : '';
            document.getElementById('editRightUnit').value = race.rightLane ? race.rightLane.unitNumber : '';
            
            updatePositionSelects();
            
            if (race.leftLane) {
                document.getElementById('editLeftPosition').value = race.leftLane.position;
                updateCompetitorName('editLeftName', race.leftLane.unitNumber, race.leftLane.position);
            }
            
            if (race.rightLane) {
                document.getElementById('editRightPosition').value = race.rightLane.position;
                updateCompetitorName('editRightName', race.rightLane.unitNumber, race.rightLane.position);
            }
            
            document.getElementById('editRaceModal').classList.add('active');
        }
        
        function updateEditModalsSelects() {
            const leftSelect = document.getElementById('editLeftUnit');
            const rightSelect = document.getElementById('editRightUnit');
            
            if (leftSelect && rightSelect) {
                const unitOptions = '<option value="">Brak</option>' + 
                    units.filter(u => u.number !== null)
                          .sort((a, b) => a.number - b.number)
                          .map(unit => `<option value="${unit.number}">${unit.number} - ${unit.name}</option>`)
                          .join('');
                
                leftSelect.innerHTML = unitOptions;
                rightSelect.innerHTML = unitOptions;
                
                leftSelect.onchange = () => updatePositionSelects();
                rightSelect.onchange = () => updatePositionSelects();
            }
            
            updateQuickSelects();
        }
        
        function updateQuickSelects() {
            const quickLeftUnit = document.getElementById('quickLeftUnit');
            const quickRightUnit = document.getElementById('quickRightUnit');
            
            if (quickLeftUnit && quickRightUnit) {
                const unitOptions = '<option value="">-</option>' + 
                    units.filter(u => u.number !== null)
                          .sort((a, b) => a.number - b.number)
                          .map(unit => `<option value="${unit.number}">${unit.number}</option>`)
                          .join('');
                
                quickLeftUnit.innerHTML = unitOptions;
                quickRightUnit.innerHTML = unitOptions;
                
                quickLeftUnit.onchange = () => updateQuickPositions();
                quickRightUnit.onchange = () => updateQuickPositions();
                
                document.getElementById('quickLeftPos').onchange = () => updateQuickPreview();
                document.getElementById('quickRightPos').onchange = () => updateQuickPreview();
            }
        }
        
        function updateQuickPositions() {
            const leftUnit = document.getElementById('quickLeftUnit').value;
            const rightUnit = document.getElementById('quickRightUnit').value;
            
            updateQuickPositionSelect('quickLeftPos', leftUnit);
            updateQuickPositionSelect('quickRightPos', rightUnit);
            updateQuickPreview();
        }
        
        function updateQuickPositionSelect(selectId, unitNumber) {
            const select = document.getElementById(selectId);
            
            if (!unitNumber) {
                select.innerHTML = '<option value="">-</option>';
                return;
            }
            
            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return;
            
            const unitCompetitors = competitors.filter(c => c.unitId === unit.id && !c.isPK).sort((a, b) => a.position - b.position);
            
            select.innerHTML = '<option value="">-</option>' +
                unitCompetitors.map(comp => `<option value="${comp.position}">${comp.position}</option>`).join('');
        }
        
        function updateQuickPreview() {
            const leftUnit = document.getElementById('quickLeftUnit').value;
            const leftPos = document.getElementById('quickLeftPos').value;
            const rightUnit = document.getElementById('quickRightUnit').value;
            const rightPos = document.getElementById('quickRightPos').value;
            
            let preview = 'Lewy: ';
            if (leftUnit && leftPos) {
                const name = getCompetitorNameByCode(leftUnit, leftPos);
                preview += `${leftUnit}/${leftPos} - ${name}`;
            } else {
                preview += '-';
            }
            
            preview += ' vs Prawy: ';
            if (rightUnit && rightPos) {
                const name = getCompetitorNameByCode(rightUnit, rightPos);
                preview += `${rightUnit}/${rightPos} - ${name}`;
            } else {
                preview += '-';
            }
            
            document.getElementById('quickPreview').textContent = preview;
        }
        
        function getCompetitorNameByCode(unitNumber, position) {
            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return 'Nieznany';
            
            const competitor = competitors.find(c => c.unitId === unit.id && c.position == position && !c.isPK);
            return competitor ? `${competitor.firstName} ${competitor.lastName}` : 'Nieznany';
        }
        
        function addQuickRace() {
            const leftUnit = document.getElementById('quickLeftUnit').value;
            const leftPos = document.getElementById('quickLeftPos').value;
            const rightUnit = document.getElementById('quickRightUnit').value;
            const rightPos = document.getElementById('quickRightPos').value;
            
            if (!leftUnit && !rightUnit) {
                alert('Wybierz przynajmniej jednego zawodnika');
                return;
            }
            
            quickAddRace(leftUnit, leftPos, rightUnit, rightPos);
            
            document.getElementById('quickLeftUnit').value = '';
            document.getElementById('quickLeftPos').value = '';
            document.getElementById('quickRightUnit').value = '';
            document.getElementById('quickRightPos').value = '';
            updateQuickPreview();
        }
        
        function updatePositionSelects() {
            const leftUnit = document.getElementById('editLeftUnit').value;
            const rightUnit = document.getElementById('editRightUnit').value;
            
            updatePositionSelectForLane('editLeftPosition', 'editLeftName', leftUnit);
            updatePositionSelectForLane('editRightPosition', 'editRightName', rightUnit);
        }
        
        function updatePositionSelectForLane(positionSelectId, nameSpanId, unitNumber) {
            const positionSelect = document.getElementById(positionSelectId);
            
            if (!unitNumber) {
                positionSelect.innerHTML = '<option value="">-</option>';
                document.getElementById(nameSpanId).textContent = '';
                return;
            }
            
            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return;
            
            const unitCompetitors = competitors.filter(c => c.unitId === unit.id && !c.isPK).sort((a, b) => a.position - b.position);
            
            positionSelect.innerHTML = '<option value="">-</option>' +
                unitCompetitors.map(comp => `<option value="${comp.position}">${comp.position}</option>`).join('');
            
            positionSelect.onchange = () => updateCompetitorName(nameSpanId, unitNumber, positionSelect.value);
        }
        
        function updateCompetitorName(nameSpanId, unitNumber, position) {
            const nameSpan = document.getElementById(nameSpanId);
            
            if (!unitNumber || !position) {
                nameSpan.textContent = '';
                return;
            }
            
            const unit = units.find(u => u.number == unitNumber);
            if (!unit) return;
            
            const competitor = competitors.find(c => c.unitId === unit.id && c.position == position && !c.isPK);
            nameSpan.textContent = competitor ? `(${competitor.firstName} ${competitor.lastName})` : '';
        }
        
        function saveRaceEdit() {
            const leftUnit = document.getElementById('editLeftUnit').value;
            const leftPosition = document.getElementById('editLeftPosition').value;
            const rightUnit = document.getElementById('editRightUnit').value;
            const rightPosition = document.getElementById('editRightPosition').value;
            
            const race = schema.find(r => r.id === editingRaceId);
            
            if (leftUnit && leftPosition) {
                const unit = units.find(u => u.number == leftUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == leftPosition && !c.isPK);
                race.leftLane = {
                    unitNumber: parseInt(leftUnit),
                    position: parseInt(leftPosition),
                    competitorId: competitor.id,
                    name: `${competitor.firstName} ${competitor.lastName}`
                };
            } else {
                race.leftLane = null;
            }
            
            if (rightUnit && rightPosition) {
                const unit = units.find(u => u.number == rightUnit);
                const competitor = competitors.find(c => c.unitId === unit.id && c.position == rightPosition && !c.isPK);
                race.rightLane = {
                    unitNumber: parseInt(rightUnit),
                    position: parseInt(rightPosition),
                    competitorId: competitor.id,
                    name: `${competitor.firstName} ${competitor.lastName}`
                };
            } else {
                race.rightLane = null;
            }
            
            updateSchemaList();
            closeEditModal();
        }
        
        function closeEditModal() {
            document.getElementById('editRaceModal').classList.remove('active');
            editingRaceId = null;
        }
        
        function startSeries1() {
            if (schema.length === 0) {
                alert('Brak bieg√≥w w schemacie');
                return;
            }
            
            series1Results = schema.map(race => ({
                ...race,
                leftResult: race.leftLane ? { time: '', status: 'OK' } : null,
                rightResult: race.rightLane ? { time: '', status: 'OK' } : null
            }));
            
            updateSeries1List();
            showSection('series1');
        }
        
        function updateSeries1List() {
            const container = document.getElementById('series1List');
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr><th>Bieg</th><th>Tor Lewy</th><th>Czas (MM:SS)</th><th>Status</th><th>Tor Prawy</th><th>Czas (MM:SS)</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        ${series1Results.map((race, index) => `
                            <tr>
                                <td><strong>${index + 1}</strong></td>
                                <td>${race.leftLane ? `<strong>${race.leftLane.unitNumber}/${race.leftLane.position}</strong><br><small>${race.leftLane.name}</small>` : '-'}</td>
                                <td>${race.leftLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.leftResult.time}" onchange="updateResult(1, ${race.id}, 'left', 'time', this.value)">` : '-'}</td>
                                <td>${race.leftLane ? `
                                    <select class="status-select" onchange="updateResult(1, ${race.id}, 'left', 'status', this.value)">
                                        <option value="OK" ${race.leftResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.leftResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.leftResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                                <td>${race.rightLane ? `<strong>${race.rightLane.unitNumber}/${race.rightLane.position}</strong><br><small>${race.rightLane.name}</small>` : '-'}</td>
                                <td>${race.rightLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.rightResult.time}" onchange="updateResult(1, ${race.id}, 'right', 'time', this.value)">` : '-'}</td>
                                <td>${race.rightLane ? `
                                    <select class="status-select" onchange="updateResult(1, ${race.id}, 'right', 'status', this.value)">
                                        <option value="OK" ${race.rightResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.rightResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.rightResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('startSeries2Btn').style.display = 'block';
        }
        
        function updateResult(series, raceId, lane, field, value) {
            const results = series === 1 ? series1Results : series2Results;
            const race = results.find(r => r.id === raceId);
            
            if (race) {
                const laneKey = lane === 'left' ? 'leftResult' : 'rightResult';
                if (race[laneKey]) {
                    race[laneKey][field] = value;
                }
            }
        }
        
        function startSeries2() {
            if (series1Results.length === 0) {
                alert('Najpierw musisz zako≈Ñczyƒá pierwszƒÖ seriƒô');
                return;
            }
            
            const leftLaneCompetitors = [];
            const rightLaneCompetitors = [];
            
            series1Results.forEach(race => {
                if (race.leftLane && race.leftResult) {
                    rightLaneCompetitors.push({
                        ...race.leftLane,
                        result: race.leftResult,
                        timeInSeconds: timeToSeconds(race.leftResult.time)
                    });
                }
                
                if (race.rightLane && race.rightResult) {
                    leftLaneCompetitors.push({
                        ...race.rightLane,
                        result: race.rightResult,
                        timeInSeconds: timeToSeconds(race.rightResult.time)
                    });
                }
            });
            
            const sortCompetitors = (competitors) => {
                return competitors.sort((a, b) => {
                    if (a.result.status !== 'OK') {
                        if (b.result.status !== 'OK') return 0;
                        return -1;
                    }
                    if (b.result.status !== 'OK') return 1;
                    return b.timeInSeconds - a.timeInSeconds;
                });
            };
            
            const sortedLeftLane = sortCompetitors([...leftLaneCompetitors]);
            const sortedRightLane = sortCompetitors([...rightLaneCompetitors]);
            
            const series2Races = [];
            const leftCount = sortedLeftLane.length;
            const rightCount = sortedRightLane.length;
            const diff = Math.abs(leftCount - rightCount);
            
            if (diff > 0) {
                const moreCompetitors = leftCount > rightCount ? sortedLeftLane : sortedRightLane;
                const laneName = leftCount > rightCount ? 'left' : 'right';
                
                for (let i = 0; i < diff; i++) {
                    const competitor = moreCompetitors[i];
                    const raceItem = {
                        id: Date.now() + series2Races.length + Math.random(),
                        leftLane: null,
                        rightLane: null,
                        leftResult: null,
                        rightResult: null
                    };
                    
                    if (laneName === 'left') {
                        raceItem.leftLane = competitor;
                        raceItem.leftResult = { time: '', status: 'OK' };
                    } else {
                        raceItem.rightLane = competitor;
                        raceItem.rightResult = { time: '', status: 'OK' };
                    }
                    
                    series2Races.push(raceItem);
                }
                
                if (leftCount > rightCount) {
                    sortedLeftLane.splice(0, diff);
                } else {
                    sortedRightLane.splice(0, diff);
                }
            }
            
            const pairCount = Math.min(sortedLeftLane.length, sortedRightLane.length);
            
            for (let i = 0; i < pairCount; i++) {
                series2Races.push({
                    id: Date.now() + series2Races.length + Math.random(),
                    leftLane: sortedLeftLane[i],
                    rightLane: sortedRightLane[i],
                    leftResult: { time: '', status: 'OK' },
                    rightResult: { time: '', status: 'OK' }
                });
            }
            
            series2Results = series2Races;
            updateSeries2List();
            showSection('series2');
        }
        
        function updateSeries2List() {
            const container = document.getElementById('series2List');
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr><th>Bieg</th><th>Tor Lewy</th><th>I Seria</th><th>Czas II (MM:SS)</th><th>Status</th><th>Tor Prawy</th><th>I Seria</th><th>Czas II (MM:SS)</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        ${series2Results.map((race, index) => `
                            <tr>
                                <td><strong>${index + 1}</strong></td>
                                <td>${race.leftLane ? `<strong>${race.leftLane.unitNumber}/${race.leftLane.position}</strong><br><small>${race.leftLane.name}</small>` : '-'}</td>
                                <td>${race.leftLane ? `${race.leftLane.result.time || '-'} (${race.leftLane.result.status})` : '-'}</td>
                                <td>${race.leftLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.leftResult.time}" onchange="updateResult(2, ${race.id}, 'left', 'time', this.value)">` : '-'}</td>
                                <td>${race.leftLane ? `
                                    <select class="status-select" onchange="updateResult(2, ${race.id}, 'left', 'status', this.value)">
                                        <option value="OK" ${race.leftResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.leftResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.leftResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                                <td>${race.rightLane ? `<strong>${race.rightLane.unitNumber}/${race.rightLane.position}</strong><br><small>${race.rightLane.name}</small>` : '-'}</td>
                                <td>${race.rightLane ? `${race.rightLane.result.time || '-'} (${race.rightLane.result.status})` : '-'}</td>
                                <td>${race.rightLane ? `<input type="text" class="time-input" placeholder="MM:SS" value="${race.rightResult.time}" onchange="updateResult(2, ${race.id}, 'right', 'time', this.value)">` : '-'}</td>
                                <td>${race.rightLane ? `
                                    <select class="status-select" onchange="updateResult(2, ${race.id}, 'right', 'status', this.value)">
                                        <option value="OK" ${race.rightResult.status === 'OK' ? 'selected' : ''}>OK</option>
                                        <option value="DDF" ${race.rightResult.status === 'DDF' ? 'selected' : ''}>DDF</option>
                                        <option value="DSQ" ${race.rightResult.status === 'DSQ' ? 'selected' : ''}>DSQ</option>
                                    </select>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('generateResultsBtn').style.display = 'block';
        }
        
        function generateFinalResults() {
            if (series1Results.length === 0 || series2Results.length === 0) {
                alert('Musisz przeprowadziƒá obie serie bieg√≥w');
                return;
            }
            
            const finalResults = calculateFinalResults();
            updateFinalResultsList(finalResults);
            showSection('results');
        }
        
        function calculateFinalResults() {
            const allCompetitors = new Map();
            
            series1Results.forEach(race => {
                if (race.leftLane && race.leftResult) {
                    allCompetitors.set(race.leftLane.competitorId, {
                        ...race.leftLane,
                        series1: race.leftResult,
                        series2: null
                    });
                }
                if (race.rightLane && race.rightResult) {
                    allCompetitors.set(race.rightLane.competitorId, {
                        ...race.rightLane,
                        series1: race.rightResult,
                        series2: null
                    });
                }
            });
            
            series2Results.forEach(race => {
                if (race.leftLane && race.leftResult) {
                    const competitor = allCompetitors.get(race.leftLane.competitorId);
                    if (competitor) {
                        competitor.series2 = race.leftResult;
                    }
                }
                if (race.rightLane && race.rightResult) {
                    const competitor = allCompetitors.get(race.rightLane.competitorId);
                    if (competitor) {
                        competitor.series2 = race.rightResult;
                    }
                }
            });
            
            const results = [];
            allCompetitors.forEach(comp => {
                const competitorData = competitors.find(c => c.id === comp.competitorId);
                const unit = units.find(u => u.id === competitorData.unitId);
                
                let bestTime = null;
                let bestTimeSeries = null;
                let bestTimeSeconds = 9999;
                
                if (comp.series1 && comp.series1.status === 'OK' && comp.series1.time) {
                    const time1 = timeToSeconds(comp.series1.time);
                    if (time1 < bestTimeSeconds) {
                        bestTime = comp.series1.time;
                        bestTimeSeries = 1;
                        bestTimeSeconds = time1;
                    }
                }
                
                if (comp.series2 && comp.series2.status === 'OK' && comp.series2.time) {
                    const time2 = timeToSeconds(comp.series2.time);
                    if (time2 < bestTimeSeconds) {
                        bestTime = comp.series2.time;
                        bestTimeSeries = 2;
                        bestTimeSeconds = time2;
                    }
                }
                
                results.push({
                    ...competitorData,
                    unitName: unit.name,
                    unitNumber: comp.unitNumber,
                    competitorPosition: comp.position,
                    series1: comp.series1,
                    series2: comp.series2,
                    bestTime: bestTime,
                    bestTimeSeries: bestTimeSeries,
                    bestTimeSeconds: bestTimeSeconds
                });
            });
            
            const regularResults = results.filter(r => !r.isPK);
            const pkResults = results.filter(r => r.isPK);
            
            const maleResults = regularResults.filter(r => r.gender === 'M');
            const femaleResults = regularResults.filter(r => r.gender === 'K');
            
            const sortResults = (results) => {
                return results.sort((a, b) => {
                    const aTotalDQ = (!a.series1 || a.series1.status !== 'OK') && (!a.series2 || a.series2.status !== 'OK');
                    const bTotalDQ = (!b.series1 || b.series1.status !== 'OK') && (!b.series2 || b.series2.status !== 'OK');
                    
                    if (aTotalDQ && !bTotalDQ) return 1;
                    if (!aTotalDQ && bTotalDQ) return -1;
                    if (aTotalDQ && bTotalDQ) return a.lastName.localeCompare(b.lastName);
                    
                    if (a.bestTime && b.bestTime) {
                        return a.bestTimeSeconds - b.bestTimeSeconds;
                    }
                    
                    if (a.bestTime) return -1;
                    if (b.bestTime) return 1;
                    
                    return a.lastName.localeCompare(b.lastName);
                });
            };
            
            const sortedMale = sortResults([...maleResults]);
            const sortedFemale = sortResults([...femaleResults]);
            const sortedPK = sortResults([...pkResults]);
            
            const addPositions = (results) => {
                let position = 1;
                results.forEach((result, index) => {
                    const hasTotalDQ = (!result.series1 || result.series1.status !== 'OK') && (!result.series2 || result.series2.status !== 'OK');
                    
                    if (hasTotalDQ) {
                        result.finalPosition = 'DQ';
                    } else if (result.bestTime) {
                        if (index > 0 && results[index-1].bestTime === result.bestTime && results[index-1].finalPosition !== 'DQ') {
                            result.finalPosition = results[index-1].finalPosition;
                        } else {
                            result.finalPosition = position;
                        }
                    } else {
                        result.finalPosition = '-';
                    }
                    position++;
                });
            };
            
            addPositions(sortedMale);
            addPositions(sortedFemale);
            addPositions(sortedPK);
            
            return {
                male: sortedMale,
                female: sortedFemale,
                pk: sortedPK,
                all: [...sortedMale, ...sortedFemale]
            };
        }
        
        function showResults(category) {
            currentResultsView = category;
            document.querySelectorAll('#results .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`results${category.charAt(0).toUpperCase() + category.slice(1)}Btn`).classList.add('active');
            
            const finalResults = calculateFinalResults();
            updateFinalResultsList(finalResults);
        }
        
        function updateFinalResultsList(finalResults) {
            const container = document.getElementById('finalResultsList');
            
            let resultsToShow = [];
            if (currentResultsView === 'all') {
                resultsToShow = finalResults.all;
            } else if (currentResultsView === 'M') {
                resultsToShow = finalResults.male;
            } else if (currentResultsView === 'K') {
                resultsToShow = finalResults.female;
            }
            
            container.innerHTML = `
                <h4>Klasyfikacja ${currentResultsView === 'all' ? 'Og√≥lna' : currentResultsView === 'M' ? 'Mƒô≈ºczyzn' : 'Kobiet'}</h4>
                <table>
                    <thead>
                        <tr><th>Miejsce</th><th>Zawodnik</th><th>Jednostka</th><th>I Seria</th><th>II Seria</th><th>Najlepszy czas</th><th>Seria</th></tr>
                    </thead>
                    <tbody>
                        ${resultsToShow.map(result => `
                            <tr>
                                <td><strong>${result.finalPosition}</strong></td>
                                <td><strong>${result.firstName} ${result.lastName}</strong><br><small>${result.unitNumber}/${result.competitorPosition}</small></td>
                                <td>${result.unitName}</td>
                                <td>${result.series1 ? `${result.series1.time || '-'} (${result.series1.status})` : '-'}</td>
                                <td>${result.series2 ? `${result.series2.time || '-'} (${result.series2.status})` : '-'}</td>
                                <td><strong style="color: #28a745;">${result.bestTime || '-'}</strong></td>
                                <td>${result.bestTimeSeries || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                ${finalResults.pk.length > 0 && currentResultsView === 'all' ? `
                    <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                        <h4>üî∏ Zawodnicy Poza KonkurencjƒÖ (PK)</h4>
                        <table>
                            <thead>
                                <tr><th>Lp.</th><th>Zawodnik</th><th>Jednostka</th><th>I Seria</th><th>II Seria</th><th>Najlepszy czas</th><th>Seria</th></tr>
                            </thead>
                            <tbody>
                                ${finalResults.pk.map((result, index) => `
                                    <tr>
                                        <td><strong>PK-${index + 1}</strong></td>
                                        <td><strong>${result.firstName} ${result.lastName}</strong><br><small>${result.unitNumber}/${result.competitorPosition}</small></td>
                                        <td>${result.unitName}</td>
                                        <td>${result.series1 ? `${result.series1.time || '-'} (${result.series1.status})` : '-'}</td>
                                        <td>${result.series2 ? `${result.series2.time || '-'} (${result.series2.status})` : '-'}</td>
                                        <td><strong style="color: #28a745;">${result.bestTime || '-'}</strong></td>
                                        <td>${result.bestTimeSeries || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            `;
        }
        
        function printSection(sectionId) {
            const eventName = document.getElementById('eventName').value;
            const eventLocation = document.getElementById('eventLocation').value;
            const currentDate = new Date().toLocaleDateString('pl-PL');
            
            let printContent = '';
            let title = '';
            
            if (sectionId === 'schema') {
                title = 'SCHEMAT BIEG√ìW - I SERIA';
                printContent = generateSchemaPrint();
            } else if (sectionId === 'series1') {
                title = 'LISTA STARTOWA - I SERIA';
                printContent = generateSeries1Print();
            } else if (sectionId === 'series2') {
                title = 'LISTA STARTOWA - II SERIA';
                printContent = generateSeries2Print();
            } else if (sectionId === 'results') {
                title = 'WYNIKI KO≈ÉCOWE';
                printContent = generateResultsPrint();
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>OSF - ${title}</title>
                        <meta charset="UTF-8">
                        <style>
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                            
                            body {
                                font-family: 'Arial', sans-serif;
                                font-size: 12px;
                                line-height: 1.4;
                                color: #000;
                                margin: 0;
                                padding: 0;
                            }
                            
                            .header {
                                text-align: center;
                                margin-bottom: 25px;
                                padding-bottom: 15px;
                                border-bottom: 3px double #000;
                            }
                            
                            .logo {
                                font-size: 18px;
                                font-weight: bold;
                                color: #2c3e50;
                                margin-bottom: 5px;
                            }
                            
                            .title {
                                font-size: 16px;
                                font-weight: bold;
                                margin: 10px 0;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                            }
                            
                            .event-info {
                                margin: 15px 0;
                                padding: 10px;
                                background: #f8f9fa;
                                border-left: 4px solid #007bff;
                            }
                            
                            .event-info .name {
                                font-size: 14px;
                                font-weight: bold;
                                margin-bottom: 5px;
                            }
                            
                            .event-info .location {
                                font-size: 12px;
                                color: #666;
                            }
                            
                            .meta-info {
                                display: flex;
                                justify-content: space-between;
                                margin: 15px 0;
                                font-size: 10px;
                                color: #666;
                            }
                            
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 20px 0;
                                font-size: 11px;
                            }
                            
                            th {
                                background: #2c3e50;
                                color: white;
                                padding: 8px 6px;
                                text-align: center;
                                font-weight: bold;
                                border: 1px solid #000;
                                font-size: 10px;
                            }
                            
                            td {
                                padding: 6px;
                                border: 1px solid #666;
                                text-align: center;
                                vertical-align: middle;
                            }
                            
                            tr:nth-child(even) {
                                background: #f9f9f9;
                            }
                            
                            .race-number {
                                font-weight: bold;
                                font-size: 12px;
                                background: #e9ecef !important;
                            }
                            
                            .competitor-info {
                                text-align: left;
                                padding-left: 8px;
                            }
                            
                            .competitor-code {
                                font-weight: bold;
                                color: #007bff;
                            }
                            
                            .competitor-name {
                                font-size: 10px;
                                color: #333;
                                margin-top: 2px;
                            }
                            
                            .unit-name {
                                font-size: 9px;
                                color: #666;
                                font-style: italic;
                            }
                            
                            .time-cell {
                                min-width: 60px;
                                background: #fff;
                            }
                            
                            .status-cell {
                                min-width: 45px;
                            }
                            
                            .result-position {
                                font-weight: bold;
                                font-size: 14px;
                                color: #007bff;
                            }
                            
                            .best-time {
                                font-weight: bold;
                                color: #28a745;
                                font-size: 12px;
                            }
                            
                            .pk-section {
                                margin-top: 30px;
                                padding: 15px;
                                background: #fff3cd;
                                border: 2px solid #ffc107;
                                border-radius: 5px;
                            }
                            
                            .pk-title {
                                font-weight: bold;
                                color: #856404;
                                text-align: center;
                                margin-bottom: 10px;
                                font-size: 12px;
                            }
                            
                            .footer {
                                margin-top: 30px;
                                padding-top: 15px;
                                border-top: 2px solid #dee2e6;
                                text-align: center;
                                font-size: 10px;
                                color: #666;
                            }
                            
                            .signature-area {
                                margin-top: 40px;
                                display: flex;
                                justify-content: space-between;
                            }
                            
                            .signature-box {
                                width: 200px;
                                text-align: center;
                            }
                            
                            .signature-line {
                                border-top: 1px solid #000;
                                margin-top: 40px;
                                padding-top: 5px;
                                font-size: 10px;
                            }
                            
                            @media print {
                                body { print-color-adjust: exact; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="logo">üèÜ OSF - O≈öRODEK SPRAWNO≈öCI FIZYCZNEJ</div>
                            <div class="title">${title}</div>
                            ${(eventName || eventLocation) ? `
                                <div class="event-info">
                                    ${eventName ? `<div class="name">${eventName}</div>` : ''}
                                    ${eventLocation ? `<div class="location">Miejscowo≈õƒá: ${eventLocation}</div>` : ''}
                                </div>
                            ` : ''}
                            <div class="meta-info">
                                <span>Data wydruku: ${currentDate}</span>
                                <span>System OSF v1.0</span>
                            </div>
                        </div>
                        
                        ${printContent}
                        
                        <div class="signature-area">
                            <div class="signature-box">
                                <div class="signature-line">Sƒôdzia G≈Ç√≥wny</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line">Organizator</div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <div>Opracowanie: YO&GO Events | System OSF</div>
                            <div style="margin-top: 5px;">Wydrukowano: ${new Date().toLocaleString('pl-PL')}</div>
                        </div>
                        
                        <div class="no-print" style="position: fixed; top: 10px; right: 10px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">üñ®Ô∏è Drukuj</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer;">‚úñÔ∏è Zamknij</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function generateSchemaPrint() {
            if (schema.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak zdefiniowanych bieg√≥w w schemacie.</p>';
            }
            
            return `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 60px;">BIEG</th>
                            <th style="width: 40%;">TOR LEWY</th>
                            <th style="width: 40%;">TOR PRAWY</th>
                            <th style="width: 100px;">UWAGI</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${schema.map((race, index) => `
                            <tr>
                                <td class="race-number">${index + 1}</td>
                                <td class="competitor-info">
                                    ${race.leftLane ? `
                                        <div class="competitor-code">${race.leftLane.unitNumber}/${race.leftLane.position}</div>
                                        <div class="competitor-name">${race.leftLane.name}</div>
                                        <div class="unit-name">${units.find(u => u.number === race.leftLane.unitNumber)?.name || ''}</div>
                                    ` : '<span style="color: #999;">-</span>'}
                                </td>
                                <td class="competitor-info">
                                    ${race.rightLane ? `
                                        <div class="competitor-code">${race.rightLane.unitNumber}/${race.rightLane.position}</div>
                                        <div class="competitor-name">${race.rightLane.name}</div>
                                        <div class="unit-name">${units.find(u => u.number === race.rightLane.unitNumber)?.name || ''}</div>
                                    ` : '<span style="color: #999;">-</span>'}
                                </td>
                                <td style="background: #f8f9fa;"></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3;">
                    <strong>Informacje:</strong><br>
                    ‚Ä¢ Liczba bieg√≥w: ${schema.length}<br>
                    ‚Ä¢ Zawodnicy PK nie biorƒÖ udzia≈Çu w I serii<br>
                    ‚Ä¢ W II serii nastƒÖpi bezwzglƒôdna zmiana tor√≥w
                </div>
            `;
        }
        
        function generateSeries1Print() {
            if (series1Results.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak listy startowej I serii.</p>';
            }
            
            return `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">BIEG</th>
                            <th style="width: 35%;">TOR LEWY</th>
                            <th style="width: 70px;">CZAS</th>
                            <th style="width: 50px;">STATUS</th>
                            <th style="width: 35%;">TOR PRAWY</th>
                            <th style="width: 70px;">CZAS</th>
                            <th style="width: 50px;">STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${series1Results.map((race, index) => `
                            <tr>
                                <td class="race-number">${index + 1}</td>
                                <td class="competitor-info">
                                    ${race.leftLane ? `
                                        <div class="competitor-code">${race.leftLane.unitNumber}/${race.leftLane.position}</div>
                                        <div class="competitor-name">${race.leftLane.name}</div>
                                        <div class="unit-name">${units.find(u => u.number === race.leftLane.unitNumber)?.name || ''}</div>
                                    ` : '-'}
                                </td>
                                <td class="time-cell">_____:_____</td>
                                <td class="status-cell">_____</td>
                                <td class="competitor-info">
                                    ${race.rightLane ? `
                                        <div class="competitor-code">${race.rightLane.unitNumber}/${race.rightLane.position}</div>
                                        <div class="competitor-name">${race.rightLane.name}</div>
                                        <div class="unit-name">${units.find(u => u.number === race.rightLane.unitNumber)?.name || ''}</div>
                                    ` : '-'}
                                </td>
                                <td class="time-cell">_____:_____</td>
                                <td class="status-cell">_____</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6;">
                    <strong>Oznaczenia status√≥w:</strong> OK - uko≈Ñczy≈Ç, DDF - nie uko≈Ñczy≈Ç, DSQ - dyskwalifikacja
                </div>
            `;
        }
        
        function generateSeries2Print() {
            if (series2Results.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak listy startowej II serii.</p>';
            }
            
            return `
                <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107;">
                    <strong>ZASADY II SERII:</strong><br>
                    ‚Ä¢ Bezwzglƒôdna zmiana tor√≥w (lewy ‚Üî prawy)<br>
                    ‚Ä¢ Kolejno≈õƒá: DDF/DSQ ‚Üí najgorsze czasy ‚Üí najlepsze czasy<br>
                    ‚Ä¢ Pierwsze biegi mogƒÖ byƒá pojedyncze przy nier√≥wnej liczbie zawodnik√≥w
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">BIEG</th>
                            <th style="width: 25%;">TOR LEWY</th>
                            <th style="width: 60px;">I SERIA</th>
                            <th style="width: 70px;">CZAS II</th>
                            <th style="width: 50px;">STATUS</th>
                            <th style="width: 25%;">TOR PRAWY</th>
                            <th style="width: 60px;">I SERIA</th>
                            <th style="width: 70px;">CZAS II</th>
                            <th style="width: 50px;">STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${series2Results.map((race, index) => `
                            <tr>
                                <td class="race-number">${index + 1}</td>
                                <td class="competitor-info">
                                    ${race.leftLane ? `
                                        <div class="competitor-code">${race.leftLane.unitNumber}/${race.leftLane.position}</div>
                                        <div class="competitor-name">${race.leftLane.name}</div>
                                    ` : '-'}
                                </td>
                                <td style="font-size: 9px;">
                                    ${race.leftLane ? `${race.leftLane.result.time || '-'}<br>(${race.leftLane.result.status})` : '-'}
                                </td>
                                <td class="time-cell">_____:_____</td>
                                <td class="status-cell">_____</td>
                                <td class="competitor-info">
                                    ${race.rightLane ? `
                                        <div class="competitor-code">${race.rightLane.unitNumber}/${race.rightLane.position}</div>
                                        <div class="competitor-name">${race.rightLane.name}</div>
                                    ` : '-'}
                                </td>
                                <td style="font-size: 9px;">
                                    ${race.rightLane ? `${race.rightLane.result.time || '-'}<br>(${race.rightLane.result.status})` : '-'}
                                </td>
                                <td class="time-cell">_____:_____</td>
                                <td class="status-cell">_____</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function generateResultsPrint() {
            if (series1Results.length === 0 || series2Results.length === 0) {
                return '<p style="text-align: center; font-style: italic; margin: 50px;">Brak wynik√≥w do wy≈õwietlenia.</p>';
            }
            
            const finalResults = calculateFinalResults();
            let content = '';
            
            if (finalResults.male.length > 0) {
                content += `
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 20px;">KLASYFIKACJA Mƒò≈ªCZYZN</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 60px;">MIEJSCE</th>
                                <th style="width: 30%;">ZAWODNIK</th>
                                <th style="width: 20%;">JEDNOSTKA</th>
                                <th style="width: 80px;">I SERIA</th>
                                <th style="width: 80px;">II SERIA</th>
                                <th style="width: 80px;">NAJLEPSZY</th>
                                <th style="width: 50px;">SERIA</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${finalResults.male.map(result => `
                                <tr>
                                    <td class="result-position">${result.finalPosition}</td>
                                    <td class="competitor-info">
                                        <div class="competitor-name" style="font-weight: bold;">${result.firstName} ${result.lastName}</div>
                                        <div class="competitor-code">${result.unitNumber}/${result.competitorPosition}</div>
                                    </td>
                                    <td style="text-align: left; padding-left: 8px;">${result.unitName}</td>
                                    <td style="font-size: 10px;">
                                        ${result.series1 ? `${result.series1.time || '-'}<br><span style="color: #666;">(${result.series1.status})</span>` : '-'}
                                    </td>
                                    <td style="font-size: 10px;">
                                        ${result.series2 ? `${result.series2.time || '-'}<br><span style="color: #666;">(${result.series2.status})</span>` : '-'}
                                    </td>
                                    <td class="best-time">${result.bestTime || '-'}</td>
                                    <td>${result.bestTimeSeries || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            if (finalResults.female.length > 0) {
                content += `
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #e91e63; padding-bottom: 5px; margin-top: 30px;">KLASYFIKACJA KOBIET</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 60px;">MIEJSCE</th>
                                <th style="width: 30%;">ZAWODNIK</th>
                                <th style="width: 20%;">JEDNOSTKA</th>
                                <th style="width: 80px;">I SERIA</th>
                                <th style="width: 80px;">II SERIA</th>
                                <th style="width: 80px;">NAJLEPSZY</th>
                                <th style="width: 50px;">SERIA</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${finalResults.female.map(result => `
                                <tr>
                                    <td class="result-position">${result.finalPosition}</td>
                                    <td class="competitor-info">
                                        <div class="competitor-name" style="font-weight: bold;">${result.firstName} ${result.lastName}</div>
                                        <div class="competitor-code">${result.unitNumber}/${result.competitorPosition}</div>
                                    </td>
                                    <td style="text-align: left; padding-left: 8px;">${result.unitName}</td>
                                    <td style="font-size: 10px;">
                                        ${result.series1 ? `${result.series1.time || '-'}<br><span style="color: #666;">(${result.series1.status})</span>` : '-'}
                                    </td>
                                    <td style="font-size: 10px;">
                                        ${result.series2 ? `${result.series2.time || '-'}<br><span style="color: #666;">(${result.series2.status})</span>` : '-'}
                                    </td>
                                    <td class="best-time">${result.bestTime || '-'}</td>
                                    <td>${result.bestTimeSeries || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            if (finalResults.pk.length > 0) {
                content += `
                    <div class="pk-section">
                        <div class="pk-title">üî∏ ZAWODNICY POZA KONKURENCJƒÑ (PK) üî∏</div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 60px;">LP.</th>
                                    <th style="width: 30%;">ZAWODNIK</th>
                                    <th style="width: 20%;">JEDNOSTKA</th>
                                    <th style="width: 80px;">I SERIA</th>
                                    <th style="width: 80px;">II SERIA</th>
                                    <th style="width: 80px;">NAJLEPSZY</th>
                                    <th style="width: 50px;">SERIA</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${finalResults.pk.map((result, index) => `
                                    <tr style="background: #fff3cd;">
                                        <td style="font-weight: bold; color: #856404;">PK-${index + 1}</td>
                                        <td class="competitor-info">
                                            <div class="competitor-name" style="font-weight: bold;">${result.firstName} ${result.lastName}</div>
                                            <div class="competitor-code">${result.unitNumber}/${result.competitorPosition}</div>
                                        </td>
                                        <td style="text-align: left; padding-left: 8px;">${result.unitName}</td>
                                        <td style="font-size: 10px;">
                                            ${result.series1 ? `${result.series1.time || '-'}<br><span style="color: #666;">(${result.series1.status})</span>` : '-'}
                                        </td>
                                        <td style="font-size: 10px;">
                                            ${result.series2 ? `${result.series2.time || '-'}<br><span style="color: #666;">(${result.series2.status})</span>` : '-'}
                                        </td>
                                        <td class="best-time">${result.bestTime || '-'}</td>
                                        <td>${result.bestTimeSeries || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            const totalCompetitors = finalResults.male.length + finalResults.female.length;
            const totalPK = finalResults.pk.length;
            const totalDQ = [...finalResults.male, ...finalResults.female].filter(r => r.finalPosition === 'DQ').length;
            
            content += `
                <div style="margin-top: 30px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50;">
                    <h4 style="margin-bottom: 10px; color: #2e7d32;">PODSUMOWANIE ZAWOD√ìW</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 11px;">
                        <div><strong>Zawodnicy w konkurencji:</strong> ${totalCompetitors}</div>
                        <div><strong>Zawodnicy PK:</strong> ${totalPK}</div>
                        <div><strong>Mƒô≈ºczy≈∫ni:</strong> ${finalResults.male.length}</div>
                        <div><strong>Kobiety:</strong> ${finalResults.female.length}</div>
                        <div><strong>Dyskwalifikacje:</strong> ${totalDQ}</div>
                        <div><strong>≈ÅƒÖczna liczba bieg√≥w:</strong> ${series1Results.length + series2Results.length}</div>
                    </div>
                </div>
            `;
            
            return content;
        }
        
        // Event listeners
        document.getElementById('editRaceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('editRaceModal').classList.contains('active')) {
                closeEditModal();
            }
        });
        
        // Initialize
        updateUnitsTable();
        updateCompetitorUnitSelect();
        updateCompetitorsList();
        updateEditModalsSelects();
        
        setTimeout(() => {
            updateQuickPreview();
        }, 100);
    </script>
</body>
</html>