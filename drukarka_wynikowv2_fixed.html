<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YO&GO Events Results Printer</title>
    <style>
        :root {
            --primary-color: #FF8C00;
            --secondary-color: #FF7000;
            --success-color: #28a745;
            --error-color: #dc3545;
            --light-bg: #f8f9fa;
            --border-color: #ddd;
            --text-color: #333;
            --receipt-width: 80mm;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: var(--text-color);
            background-color: #f5f5f5;
            padding: 8px;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 16px;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        
        .app-version {
            position: absolute;
            right: 10px;
            bottom: 5px;
            font-size: 10px;
            opacity: 0.8;
        }
        
        .screen {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .screen.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 8px;
        }
        
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button.secondary {
            background-color: #6c757d;
        }
        
        button.secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-lg {
            padding: 12px 20px;
            font-size: 16px;
            width: 100%;
            margin-top: 15px;
        }
        
        .flex-container {
            display: flex;
            gap: 15px;
        }
        
        .flex-column {
            flex: 1;
        }
        
        .panel {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .panel h2 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 15px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .status {
            padding: 6px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status.loading {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .hidden {
            display: none;
        }
        
        .receipt-container {
            max-width: var(--receipt-width);
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform-origin: top center;
            transition: transform 0.3s;
            height: 100%;
            overflow-y: auto;
        }
        
        .receipt {
            width: var(--receipt-width);
            background-color: white;
            border: 1px dashed #ccc;
            padding: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid black;
            padding-bottom: 8px;
        }
        
        .receipt-header h2 {
            font-size: 14px;
            margin: 0;
            margin-bottom: 5px;
        }
        
        .receipt-header p {
            font-size: 11px;
            margin: 0;
        }
        
        .receipt-line {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            font-size: 11px;
        }
        
        .receipt-center {
            text-align: center;
            font-size: 11px;
            margin: 6px 0;
        }
        
        .receipt-separator {
            border-bottom: 1px dashed black;
            margin: 8px 0;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid black;
            font-size: 10px;
        }
        
        .athlete-search {
            position: relative;
            margin-bottom: 10px;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .search-result-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .search-result-item:hover {
            background-color: var(--light-bg);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .bib-number {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .athlete-name {
            margin-left: 8px;
        }
        
        .athlete-details {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        nav {
            background-color: #f0f0f0;
            border-bottom: 1px solid var(--border-color);
            padding: 0;
        }
        
        nav button {
            background-color: transparent;
            color: var(--text-color);
            border: none;
            border-radius: 0;
            padding: 10px 16px;
            font-size: 13px;
            transition: background-color 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        nav button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        nav button.active {
            background-color: white;
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }
        
        .api-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: var(--light-bg);
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .api-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .api-status-indicator.connected {
            background-color: var(--success-color);
        }
        
        .api-status-indicator.disconnected {
            background-color: var(--error-color);
        }
        
        .last-sync-info {
            color: #666;
            font-size: 11px;
        }
        
        @media print {
            body, html {
                margin: 0;
                padding: 0;
                width: var(--receipt-width);
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
                height: auto;
            }
            
            header, nav, .panel:not(.receipt-container) {
                display: none !important;
            }
            
            .screen {
                padding: 0;
            }
            
            .receipt-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            
            .receipt {
                border: none;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÉ YO&GO Events - Results Printer</h1>
            <div class="app-version">v2.2 - KATEGORIE+</div>
        </header>
        
        <nav>
            <button class="nav-btn active" data-screen="search">Szukaj i Drukuj</button>
            <button class="nav-btn" data-screen="settings">Ustawienia</button>
        </nav>
        
        <!-- EKRAN G≈Å√ìWNY - SZUKAJ I DRUKUJ -->
        <div class="screen active" id="search-screen">
            <div class="flex-container">
                <!-- Lewa kolumna - Wyszukiwanie -->
                <div class="flex-column">
                    <div class="panel">
                        <h2>üîç Wyszukaj zawodnika</h2>
                        
                        <div class="api-status" id="api-status">
                            <div>
                                <span class="api-status-indicator disconnected" id="api-indicator"></span>
                                <span id="api-status-text">≈ÅƒÖczenie z API...</span>
                            </div>
                            <div class="last-sync-info" id="last-sync-info">-</div>
                        </div>
                        
                        <div class="athlete-search">
                            <input 
                                type="text" 
                                id="athlete-search" 
                                placeholder="Wpisz numer startowy lub nazwisko..." 
                                autocomplete="off"
                            >
                            <div class="search-results hidden" id="search-results"></div>
                        </div>
                        
                        <div id="no-results" class="status hidden"></div>
                    </div>
                </div>
                
                <!-- Prawa kolumna - PodglƒÖd paragonu -->
                <div class="flex-column">
                    <div class="panel">
                        <h2>üìÑ PodglƒÖd paragonu</h2>
                        <div class="receipt-container" id="receipt-preview">
                            <div class="status">Wyszukaj zawodnika, aby zobaczyƒá podglƒÖd</div>
                        </div>
                    </div>
                    
                    <button id="print-btn" class="btn-lg" style="display: none;">
                        üñ®Ô∏è Drukuj wynik
                    </button>
                </div>
            </div>
        </div>
        
        <!-- EKRAN USTAWIE≈É -->
        <div class="screen" id="settings-screen">
            <div class="flex-container">
                <div class="flex-column">
                    <div class="panel">
                        <h2>‚öôÔ∏è Konfiguracja API</h2>
                        
                        <div class="form-group">
                            <label for="event-id">ID Wydarzenia (Event ID):</label>
                            <input type="text" id="event-id" placeholder="np. 12345">
                        </div>
                        
                        <div class="form-group">
                            <label for="api-key">Klucz API (opcjonalny):</label>
                            <input type="password" id="api-key" placeholder="Pozostaw puste dla publicznych wydarze≈Ñ">
                        </div>
                        
                        <div id="api-config-status" class="status hidden"></div>
                    </div>
                    
                    <div class="panel">
                        <h2>‚úèÔ∏è W≈Çasne wiadomo≈õci</h2>
                        
                        <div class="form-group">
                            <label for="custom-message">Dodatkowa wiadomo≈õƒá (opcjonalna):</label>
                            <input 
                                type="text" 
                                id="custom-message" 
                                placeholder="np. Gratulacje! ≈öwietny wynik!"
                                maxlength="48"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="footer-message">Stopka paragonu:</label>
                            <input 
                                type="text" 
                                id="footer-message" 
                                placeholder="np. YO&GO Events - Tw√≥j pomiar czasu"
                                maxlength="48"
                            >
                        </div>
                    </div>
                </div>
                
                <div class="flex-column">
                    <div class="panel">
                        <h2>üñ®Ô∏è Konfiguracja drukarki</h2>
                        
                        <div class="form-group">
                            <label for="printer-type">Typ drukarki:</label>
                            <select id="printer-type">
                                <option value="system">Systemowa (okno drukowania)</option>
                                <option value="usb">USB (Web USB API)</option>
                            </select>
                        </div>
                        
                        <div id="usb-printer-config" class="hidden">
                            <button id="connect-printer-btn" class="btn-lg">
                                üîå Po≈ÇƒÖcz drukarkƒô USB
                            </button>
                            
                            <div id="printer-connection-status" class="status hidden"></div>
                            
                            <button id="test-print-btn" class="btn-lg secondary" style="display: none;">
                                üß™ Test drukowania
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // =====================================
        // Konfiguracja
        // =====================================
        
        const config = {
            api: {
                baseUrl: 'https://api.chronotrack.com/api/event',
                eventId: localStorage.getItem('chronotrack-event-id') || '',
                apiKey: localStorage.getItem('chronotrack-api-key') || '',
                refreshInterval: 30000, // 30 sekund
                // Parametry autoryzacji ChronoTrack API v1
                clientId: '727dae7f',
                userId: 'lukasz@yogoevents.pl',
                userPass: 'f2b2f3082a9d2ae5091eb5920bee538dc01bb413',
            },
            printer: {
                type: localStorage.getItem('printer-type') || 'system',
                device: null,
                connected: false,
                vendorId: null,
                productId: null,
                interface: null,
                endpointOut: null,
                keepAliveInterval: null, // NOWE: interwa≈Ç keep-alive
                reconnectAttempts: 0, // NOWE: licznik pr√≥b ponownego po≈ÇƒÖczenia
                maxReconnectAttempts: 3, // NOWE: maksymalna liczba pr√≥b
            },
            customMessages: {
                custom: localStorage.getItem('custom-message') || '',
                footer: localStorage.getItem('footer-message') || 'YO&GO Events - Tw√≥j pomiar czasu'
            }
        };
        
        // Cache danych
        let athletesCache = [];
        let lastSyncTime = null;
        let refreshTimer = null;
        let selectedAthlete = null;
        
        // =====================================
        // Elementy DOM
        // =====================================
        
        const ui = {
            // Nawigacja
            navButtons: document.querySelectorAll('.nav-btn'),
            screens: document.querySelectorAll('.screen'),
            
            // Ekran wyszukiwania
            athleteSearchInput: document.getElementById('athlete-search'),
            searchResults: document.getElementById('search-results'),
            noResults: document.getElementById('no-results'),
            receiptPreview: document.getElementById('receipt-preview'),
            printBtn: document.getElementById('print-btn'),
            
            // Status API
            apiStatus: document.getElementById('api-status'),
            apiIndicator: document.getElementById('api-indicator'),
            apiStatusText: document.getElementById('api-status-text'),
            lastSyncInfo: document.getElementById('last-sync-info'),
            
            // Ustawienia API
            eventIdInput: document.getElementById('event-id'),
            apiKeyInput: document.getElementById('api-key'),
            apiConfigStatus: document.getElementById('api-config-status'),
            
            // Ustawienia wiadomo≈õci
            customMessageInput: document.getElementById('custom-message'),
            footerMessageInput: document.getElementById('footer-message'),
            
            // Ustawienia drukarki
            printerType: document.getElementById('printer-type'),
            usbPrinterConfig: document.getElementById('usb-printer-config'),
            connectPrinterBtn: document.getElementById('connect-printer-btn'),
            printerConnectionStatus: document.getElementById('printer-connection-status'),
            testPrintBtn: document.getElementById('test-print-btn'),
        };
        
        // =====================================
        // Funkcje pomocnicze
        // =====================================
        
        /**
         * Aktualizacja statusu
         */
        function setStatus(elementId, message, type = 'loading') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = message;
            element.className = `status ${type}`;
            element.classList.remove('hidden');
            
            // Auto-ukryj powiadomienia sukcesu po 5 sekundach
            if (type === 'success') {
                setTimeout(() => {
                    element.classList.add('hidden');
                }, 5000);
            }
        }
        
        /**
         * Aktualizacja statusu API
         */
        function updateApiStatus(connected, message) {
            ui.apiIndicator.className = `api-status-indicator ${connected ? 'connected' : 'disconnected'}`;
            ui.apiStatusText.textContent = message;
            
            if (lastSyncTime) {
                const timeAgo = getTimeAgo(lastSyncTime);
                ui.lastSyncInfo.textContent = `Ostatnia synchronizacja: ${timeAgo}`;
            }
        }
        
        /**
         * Oblicz czas wzglƒôdny
         */
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'przed chwilƒÖ';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min temu`;
            return `${Math.floor(seconds / 3600)} godz. temu`;
        }
        
        /**
         * Prze≈ÇƒÖczanie ekran√≥w
         */
        ui.navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetScreen = btn.dataset.screen;
                
                // Aktualizuj przyciski nawigacji
                ui.navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Prze≈ÇƒÖcz ekrany
                ui.screens.forEach(screen => {
                    screen.classList.remove('active');
                    if (screen.id === `${targetScreen}-screen`) {
                        screen.classList.add('active');
                    }
                });
            });
        });
        
        // =====================================
        // ZarzƒÖdzanie drukarkƒÖ USB
        // =====================================
        
        /**
         * NOWE: Keep-alive dla po≈ÇƒÖczenia USB
         * Wysy≈Ça pustƒÖ komendƒô co 15 sekund, aby utrzymaƒá po≈ÇƒÖczenie
         */
        function startKeepAlive() {
            // Wyczy≈õƒá poprzedni interwa≈Ç je≈õli istnieje
            if (config.printer.keepAliveInterval) {
                clearInterval(config.printer.keepAliveInterval);
            }
            
            // Ustaw nowy interwa≈Ç
            config.printer.keepAliveInterval = setInterval(async () => {
                if (config.printer.connected && config.printer.device) {
                    try {
                        // Wy≈õlij pustƒÖ komendƒô ESC @ (inicjalizacja) jako keep-alive
                        const keepAliveCommand = new Uint8Array([0x1B, 0x40]);
                        await config.printer.device.transferOut(
                            config.printer.endpointOut,
                            keepAliveCommand
                        );
                        console.log('Keep-alive: Po≈ÇƒÖczenie z drukarkƒÖ OK');
                    } catch (error) {
                        console.error('Keep-alive: B≈ÇƒÖd po≈ÇƒÖczenia z drukarkƒÖ:', error);
                        // Spr√≥buj ponownie po≈ÇƒÖczyƒá
                        await attemptReconnect();
                    }
                }
            }, 15000); // Co 15 sekund
        }
        
        /**
         * NOWE: Zatrzymaj keep-alive
         */
        function stopKeepAlive() {
            if (config.printer.keepAliveInterval) {
                clearInterval(config.printer.keepAliveInterval);
                config.printer.keepAliveInterval = null;
            }
        }
        
        /**
         * NOWE: Pr√≥ba ponownego po≈ÇƒÖczenia z drukarkƒÖ
         */
        async function attemptReconnect() {
            if (config.printer.reconnectAttempts >= config.printer.maxReconnectAttempts) {
                console.error('Przekroczono maksymalnƒÖ liczbƒô pr√≥b ponownego po≈ÇƒÖczenia');
                setStatus('printer-connection-status', 
                    'Drukarka roz≈ÇƒÖczona. Kliknij "Po≈ÇƒÖcz drukarkƒô USB" aby po≈ÇƒÖczyƒá ponownie.', 
                    'error');
                stopKeepAlive();
                config.printer.connected = false;
                updatePrinterStatus();
                return false;
            }
            
            config.printer.reconnectAttempts++;
            console.log(`Pr√≥ba ponownego po≈ÇƒÖczenia ${config.printer.reconnectAttempts}/${config.printer.maxReconnectAttempts}...`);
            
            try {
                // Spr√≥buj ponownie otworzyƒá urzƒÖdzenie
                if (config.printer.device) {
                    await config.printer.device.open();
                    
                    // Ponownie przejmij interfejs
                    if (config.printer.interface !== null) {
                        await config.printer.device.claimInterface(config.printer.interface);
                    }
                    
                    console.log('Ponowne po≈ÇƒÖczenie z drukarkƒÖ udane');
                    config.printer.connected = true;
                    config.printer.reconnectAttempts = 0; // Resetuj licznik
                    setStatus('printer-connection-status', 'Drukarka ponownie po≈ÇƒÖczona', 'success');
                    updatePrinterStatus();
                    return true;
                }
            } catch (error) {
                console.error(`Pr√≥ba ${config.printer.reconnectAttempts} nie powiod≈Ça siƒô:`, error);
                
                // Je≈õli to by≈Ça ostatnia pr√≥ba
                if (config.printer.reconnectAttempts >= config.printer.maxReconnectAttempts) {
                    setStatus('printer-connection-status', 
                        'Nie uda≈Ço siƒô ponownie po≈ÇƒÖczyƒá z drukarkƒÖ. Spr√≥buj po≈ÇƒÖczyƒá rƒôcznie.', 
                        'error');
                    stopKeepAlive();
                    config.printer.connected = false;
                    updatePrinterStatus();
                }
                
                return false;
            }
        }
        
        /**
         * Aktualizacja UI drukarki
         */
        function updatePrinterStatus() {
            if (config.printer.type === 'usb') {
                ui.usbPrinterConfig.classList.remove('hidden');
                
                if (config.printer.connected) {
                    ui.connectPrinterBtn.textContent = '‚úÖ Drukarka po≈ÇƒÖczona';
                    ui.connectPrinterBtn.disabled = false;
                    ui.testPrintBtn.style.display = 'block';
                } else {
                    ui.connectPrinterBtn.textContent = 'üîå Po≈ÇƒÖcz drukarkƒô USB';
                    ui.connectPrinterBtn.disabled = false;
                    ui.testPrintBtn.style.display = 'none';
                }
            } else {
                ui.usbPrinterConfig.classList.add('hidden');
            }
        }
        
        /**
         * Po≈ÇƒÖczenie z drukarkƒÖ USB przez WebUSB
         */
        ui.connectPrinterBtn.addEventListener('click', async () => {
            try {
                setStatus('printer-connection-status', 'Wybierz drukarkƒô USB...', 'loading');
                
                // Je≈õli ju≈º po≈ÇƒÖczono, roz≈ÇƒÖcz
                if (config.printer.connected && config.printer.device) {
                    try {
                        stopKeepAlive(); // NOWE: Zatrzymaj keep-alive
                        
                        if (config.printer.interface !== null) {
                            await config.printer.device.releaseInterface(config.printer.interface);
                        }
                        await config.printer.device.close();
                        config.printer.device = null;
                        config.printer.connected = false;
                        config.printer.reconnectAttempts = 0; // NOWE: Resetuj licznik
                        
                        setStatus('printer-connection-status', 'Drukarka roz≈ÇƒÖczona', 'success');
                        updatePrinterStatus();
                        return;
                    } catch (error) {
                        console.error('B≈ÇƒÖd podczas roz≈ÇƒÖczania:', error);
                    }
                }
                
                // Popro≈õ u≈ºytkownika o wyb√≥r drukarki
                const device = await navigator.usb.requestDevice({
                    filters: [
                        // Popularne drukarki termiczne
                        { vendorId: 0x0416 }, // SEWOO
                        { vendorId: 0x04b8 }, // Epson
                        { vendorId: 0x0DD4 }, // Custom Engineering
                        { vendorId: 0x1504 }, // Citizen
                        { vendorId: 0x154F }, // SNBC
                        { vendorId: 0x0519 }, // Star Micronics
                        { vendorId: 0x1A86 }, // Generic USB-Serial
                        { vendorId: 0x067B }, // Prolific
                    ]
                });
                
                console.log('Wybrano urzƒÖdzenie:', device);
                
                // Otw√≥rz urzƒÖdzenie
                await device.open();
                console.log('UrzƒÖdzenie otwarte');
                
                // Wybierz konfiguracjƒô (zazwyczaj pierwsza)
                if (device.configuration === null) {
                    await device.selectConfiguration(1);
                }
                
                // Znajd≈∫ interfejs bulk transfer
                const interfaces = device.configuration.interfaces;
                let targetInterface = null;
                let endpointOut = null;
                
                for (let iface of interfaces) {
                    const alternate = iface.alternates[0];
                    
                    // Szukamy interfejsu z endpointem OUT
                    for (let endpoint of alternate.endpoints) {
                        if (endpoint.direction === 'out' && endpoint.type === 'bulk') {
                            targetInterface = iface.interfaceNumber;
                            endpointOut = endpoint.endpointNumber;
                            break;
                        }
                    }
                    
                    if (targetInterface !== null) break;
                }
                
                if (targetInterface === null || endpointOut === null) {
                    throw new Error('Nie znaleziono odpowiedniego interfejsu drukarki');
                }
                
                console.log(`Znaleziono interfejs: ${targetInterface}, endpoint OUT: ${endpointOut}`);
                
                // Przejmij interfejs
                await device.claimInterface(targetInterface);
                console.log('Interfejs przejƒôty');
                
                // Zapisz konfiguracjƒô
                config.printer.device = device;
                config.printer.vendorId = device.vendorId;
                config.printer.productId = device.productId;
                config.printer.interface = targetInterface;
                config.printer.endpointOut = endpointOut;
                config.printer.connected = true;
                config.printer.reconnectAttempts = 0; // NOWE: Resetuj licznik
                
                // NOWE: Uruchom keep-alive
                startKeepAlive();
                
                setStatus('printer-connection-status', 
                    `Drukarka po≈ÇƒÖczona (VID: 0x${device.vendorId.toString(16)}, PID: 0x${device.productId.toString(16)})`, 
                    'success');
                updatePrinterStatus();
                
            } catch (error) {
                console.error(`B≈ÇƒÖd po≈ÇƒÖczenia z drukarkƒÖ: ${error.message}`);
                config.printer.connected = false;
                stopKeepAlive(); // NOWE: Zatrzymaj keep-alive w razie b≈Çƒôdu
                setStatus('printer-connection-status', `B≈ÇƒÖd: ${error.message}`, 'error');
                updatePrinterStatus();
            }
        });
        
        /**
         * POPRAWIONE: Wysy≈Çanie danych do drukarki USB z timeout i obs≈ÇugƒÖ b≈Çƒôd√≥w
         */
        async function sendToPrinter(data) {
            if (!config.printer.connected || !config.printer.device) {
                throw new Error('Drukarka nie jest po≈ÇƒÖczona');
            }
            
            try {
                // Konwertuj dane na Uint8Array
                const encoder = new TextEncoder();
                const dataArray = typeof data === 'string' ? encoder.encode(data) : new Uint8Array(data);
                
                // NOWE: Podziel dane na mniejsze chunki dla lepszej stabilno≈õci
                const chunkSize = 512; // 512 bajt√≥w na chunk
                const totalChunks = Math.ceil(dataArray.length / chunkSize);
                
                console.log(`Wysy≈Çanie ${dataArray.length} bajt√≥w w ${totalChunks} czƒô≈õciach...`);
                
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, dataArray.length);
                    const chunk = dataArray.slice(start, end);
                    
                    // NOWE: Timeout dla ka≈ºdego transferu
                    const transferPromise = config.printer.device.transferOut(
                        config.printer.endpointOut,
                        chunk
                    );
                    
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Transfer timeout')), 5000);
                    });
                    
                    try {
                        await Promise.race([transferPromise, timeoutPromise]);
                        console.log(`Chunk ${i + 1}/${totalChunks} wys≈Çany`);
                    } catch (error) {
                        console.error(`B≈ÇƒÖd podczas wysy≈Çania chunk ${i + 1}:`, error);
                        
                        // Spr√≥buj ponownie po≈ÇƒÖczyƒá
                        const reconnected = await attemptReconnect();
                        if (!reconnected) {
                            throw new Error('Nie uda≈Ço siƒô wys≈Çaƒá danych do drukarki');
                        }
                        
                        // Je≈õli ponowne po≈ÇƒÖczenie siƒô powiod≈Ço, spr√≥buj jeszcze raz wys≈Çaƒá ten chunk
                        await config.printer.device.transferOut(
                            config.printer.endpointOut,
                            chunk
                        );
                    }
                    
                    // Ma≈Çe op√≥≈∫nienie miƒôdzy chunkami
                    if (i < totalChunks - 1) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                console.log('Wszystkie dane wys≈Çane pomy≈õlnie');
                return true;
                
            } catch (error) {
                console.error('B≈ÇƒÖd wysy≈Çania do drukarki:', error);
                
                // Spr√≥buj ponownie po≈ÇƒÖczyƒá
                await attemptReconnect();
                
                throw error;
            }
        }
        
        /**
         * Zmiana typu drukarki
         */
        ui.printerType.addEventListener('change', () => {
            config.printer.type = ui.printerType.value;
            localStorage.setItem('printer-type', config.printer.type);
            
            // Je≈õli zmieniono z USB na systemowƒÖ, roz≈ÇƒÖcz USB
            if (config.printer.type !== 'usb' && config.printer.connected) {
                stopKeepAlive(); // NOWE: Zatrzymaj keep-alive
                
                config.printer.device.releaseInterface(config.printer.interface)
                    .then(() => config.printer.device.close())
                    .catch(console.error);
                
                config.printer.device = null;
                config.printer.connected = false;
                config.printer.reconnectAttempts = 0; // NOWE: Resetuj licznik
            }
            
            updatePrinterStatus();
        });
        
        // =====================================
        // API ChronoTrack
        // =====================================
        
        /**
         * Pobranie listy zawodnik√≥w
         */
        async function fetchAthletes() {
            if (!config.api.eventId) {
                updateApiStatus(false, 'Brak ID wydarzenia');
                return [];
            }

            try {
                updateApiStatus(false, 'Pobieranie danych...');

                // Nowy API v1 endpoint z parametrami
                const params = new URLSearchParams({
                    client_id: config.api.clientId,
                    user_id: config.api.userId,
                    user_pass: config.api.userPass,
                    format: 'json',
                    page: '1',
                    size: '10000',
                    include_all_fields: '1',
                    need_athlete_birthdate: '1'
                });

                const url = `${config.api.baseUrl}/${config.api.eventId}/results?${params.toString()}`;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // API v1 zwraca tablicƒô bezpo≈õrednio lub w data
                const results = Array.isArray(data) ? data : (data.data || data.results || []);

                if (!Array.isArray(results)) {
                    throw new Error('Nieprawid≈Çowy format danych z API');
                }

                // Przetw√≥rz dane - dodaj parsowanie bracket_positions
                athletesCache = results.map(athlete => {
                    // Parsuj bracket_positions je≈õli jest stringiem JSON
                    if (athlete.bracket_positions && typeof athlete.bracket_positions === 'string') {
                        try {
                            athlete.bracket_positions = JSON.parse(athlete.bracket_positions);
                        } catch (e) {
                            console.warn('Nie mo≈ºna sparsowaƒá bracket_positions:', e);
                        }
                    }
                    return athlete;
                });

                lastSyncTime = new Date();

                updateApiStatus(true, `Pobrano ${athletesCache.length} zawodnik√≥w`);
                console.log(`Zaktualizowano cache: ${athletesCache.length} zawodnik√≥w`);

                return athletesCache;

            } catch (error) {
                console.error('B≈ÇƒÖd pobierania danych:', error);
                updateApiStatus(false, `B≈ÇƒÖd: ${error.message}`);
                return [];
            }
        }
        
        /**
         * Automatyczne od≈õwie≈ºanie danych
         */
        function startAutoRefresh() {
            // Wyczy≈õƒá poprzedni timer
            clearRefreshTimers();
            
            // Pobierz dane natychmiast
            fetchAthletes();
            
            // Ustaw cykliczne od≈õwie≈ºanie
            refreshTimer = setInterval(() => {
                fetchAthletes();
            }, config.api.refreshInterval);
        }
        
        function clearRefreshTimers() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }
        
        function clearCache() {
            athletesCache = [];
            lastSyncTime = null;
        }
        
        /**
         * Inicjalizacja API
         */
        function initializeApi() {
            if (config.api.eventId) {
                startAutoRefresh();
            } else {
                updateApiStatus(false, 'Skonfiguruj ID wydarzenia w ustawieniach');
            }
        }
        
        // =====================================
        // Funkcje kategorii
        // =====================================

        /**
         * Sprawdza czy bracket to kategoria p≈Çci (SEX)
         */
        function isSexBracket(bracketName) {
            if (!bracketName) return false;
            const sexBrackets = ['M', 'K', 'F', 'MALE', 'FEMALE', 'Mƒò≈ªCZY≈πNI', 'KOBIETY'];
            return sexBrackets.includes(bracketName.toUpperCase());
        }

        /**
         * Sprawdza czy bracket to kategoria wiekowa (AGE)
         */
        function isAgeBracket(bracketName) {
            if (!bracketName) return false;
            // Kategorie wiekowe: M30, K25, M40-49, K50+, itp.
            return /^[MKF][\d\-\+]+/.test(bracketName);
        }

        /**
         * Wybiera najlepszƒÖ kategoriƒô wed≈Çug priorytetu
         * Priorytet: AGE (kategorie wiekowe) > CUSTOM (dodatkowe) > SEX (p≈Çeƒá)
         *
         * Logika: je≈õli nie ma kategorii wiekowej, u≈ºywaj kategorii dodatkowej
         */
        function selectBestCategory(athlete) {
            if (!athlete.bracket_positions || typeof athlete.bracket_positions !== 'object') {
                return null;
            }

            const brackets = athlete.bracket_positions;
            let ageCategory = null;
            let customCategory = null;
            let sexCategory = null;

            // Przejrzyj wszystkie kategorie
            for (const [bracketName, position] of Object.entries(brackets)) {
                if (!position || position <= 0) continue; // Pomi≈Ñ puste pozycje

                if (isAgeBracket(bracketName)) {
                    if (!ageCategory) {
                        ageCategory = { name: bracketName, position: position };
                    }
                } else if (isSexBracket(bracketName)) {
                    if (!sexCategory) {
                        sexCategory = { name: bracketName, position: position };
                    }
                } else {
                    // Kategoria dodatkowa (custom)
                    if (!customCategory) {
                        customCategory = { name: bracketName, position: position };
                    }
                }
            }

            // Wybierz wed≈Çug priorytetu:
            // 1. Je≈õli jest kategoria wiekowa -> u≈ºyj jej
            // 2. Je≈õli nie ma wiekowej ale jest custom -> u≈ºyj custom
            // 3. Je≈õli nie ma ≈ºadnej -> u≈ºyj SEX (ale to bƒôdzie rzadkie)
            if (ageCategory) {
                return ageCategory;
            } else if (customCategory) {
                return customCategory;
            } else if (sexCategory) {
                return sexCategory;
            }

            return null;
        }

        // =====================================
        // Wyszukiwanie zawodnik√≥w
        // =====================================
        
        /**
         * Wyszukiwanie zawodnik√≥w
         */
        function searchAthletes(query) {
            if (!query || query.length < 2) {
                ui.searchResults.classList.add('hidden');
                ui.noResults.classList.add('hidden');
                return [];
            }
            
            const lowerQuery = query.toLowerCase();
            
            const results = athletesCache.filter(athlete => {
                const bibMatch = athlete.entry_bib && athlete.entry_bib.toLowerCase().includes(lowerQuery);
                const nameMatch = (
                    (athlete.athlete_first_name && athlete.athlete_first_name.toLowerCase().includes(lowerQuery)) ||
                    (athlete.athlete_last_name && athlete.athlete_last_name.toLowerCase().includes(lowerQuery))
                );
                
                return bibMatch || nameMatch;
            });
            
            return results;
        }
        
        /**
         * Wy≈õwietlenie wynik√≥w wyszukiwania
         */
        function displaySearchResults(results) {
            ui.searchResults.innerHTML = '';
            
            if (results.length === 0) {
                ui.searchResults.classList.add('hidden');
                setStatus('no-results', 'Nie znaleziono zawodnik√≥w', 'error');
                return;
            }
            
            ui.noResults.classList.add('hidden');
            
            results.slice(0, 10).forEach(athlete => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                const name = `${athlete.athlete_first_name || ''} ${athlete.athlete_last_name || ''}`.trim();
                const details = [];
                
                if (athlete.bracket_name) details.push(athlete.bracket_name);
                if (athlete.race_distance) details.push(athlete.race_distance);
                
                item.innerHTML = `
                    <div>
                        <span class="bib-number">#${athlete.entry_bib || 'N/A'}</span>
                        <span class="athlete-name">${name || 'Brak nazwiska'}</span>
                    </div>
                    ${details.length > 0 ? `<div class="athlete-details">${details.join(' ‚Ä¢ ')}</div>` : ''}
                `;
                
                item.addEventListener('click', () => {
                    selectedAthlete = athlete;
                    displayAthletePreview(athlete);
                    ui.searchResults.classList.add('hidden');
                    ui.athleteSearchInput.value = `#${athlete.entry_bib} - ${name}`;
                });
                
                ui.searchResults.appendChild(item);
            });
            
            ui.searchResults.classList.remove('hidden');
        }
        
        /**
         * Obs≈Çuga wyszukiwania
         */
        let searchTimeout = null;
        ui.athleteSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                const query = e.target.value.trim();
                const results = searchAthletes(query);
                displaySearchResults(results);
            }, 300);
        });
        
        // Ukryj wyniki po klikniƒôciu poza obszarem wyszukiwania
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.athlete-search')) {
                ui.searchResults.classList.add('hidden');
            }
        });
        
        // =====================================
        // Generowanie i drukowanie paragonu
        // =====================================
        
        /**
         * Formatowanie czasu
         */
        function formatTime(seconds) {
            if (!seconds && seconds !== 0) return '-';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        /**
         * Wy≈õwietlenie podglƒÖdu zawodnika
         */
        function displayAthletePreview(athlete) {
            const name = `${athlete.athlete_first_name || ''} ${athlete.athlete_last_name || ''}`.trim();

            // Sformatuj czasy
            const netTime = athlete.formatted_net_time || formatTime(athlete.net_time);
            const gunTime = athlete.formatted_gun_time || formatTime(athlete.gun_time);

            // Wybierz najlepszƒÖ kategoriƒô wed≈Çug priorytetu
            const bestCategory = selectBestCategory(athlete);

            const html = `
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>üèÉ WYNIK BIEGU</h2>
                        <p>${athlete.race_distance || athlete.distance || 'Bieg'}</p>
                    </div>

                    <div class="receipt-line">
                        <span><strong>Numer:</strong></span>
                        <span><strong>#${athlete.entry_bib || athlete.bib || 'N/A'}</strong></span>
                    </div>

                    <div class="receipt-line">
                        <span>Zawodnik:</span>
                        <span>${name || 'Brak danych'}</span>
                    </div>

                    ${(bestCategory || athlete.bracket_name) ? `
                    <div class="receipt-line">
                        <span>Kategoria:</span>
                        <span>${bestCategory ? bestCategory.name : athlete.bracket_name}</span>
                    </div>
                    ` : ''}

                    <div class="receipt-separator"></div>

                    ${netTime && netTime !== '-' ? `
                    <div class="receipt-line">
                        <span><strong>Czas netto:</strong></span>
                        <span><strong>${netTime}</strong></span>
                    </div>
                    ` : ''}

                    ${gunTime && gunTime !== '-' ? `
                    <div class="receipt-line">
                        <span>Czas brutto:</span>
                        <span>${gunTime}</span>
                    </div>
                    ` : ''}

                    <div class="receipt-separator"></div>

                    ${athlete.overall_place ? `
                    <div class="receipt-line">
                        <span>Miejsce OPEN:</span>
                        <span>${athlete.overall_place}</span>
                    </div>
                    ` : ''}

                    ${athlete.gender_place ? `
                    <div class="receipt-line">
                        <span>Miejsce ${athlete.athlete_sex === 'M' ? 'mƒô≈ºczyzn' : 'kobiet'}:</span>
                        <span>${athlete.gender_place}</span>
                    </div>
                    ` : ''}

                    ${(bestCategory || athlete.division_place) ? `
                    <div class="receipt-line">
                        <span>Miejsce w kategorii:</span>
                        <span>${bestCategory ? bestCategory.position : athlete.division_place}</span>
                    </div>
                    ` : ''}

                    ${config.customMessages.custom ? `
                    <div class="receipt-separator"></div>
                    <div class="receipt-center">
                        <em>${config.customMessages.custom}</em>
                    </div>
                    ` : ''}

                    <div class="receipt-footer">
                        ${config.customMessages.footer}
                    </div>
                </div>
            `;

            ui.receiptPreview.innerHTML = html;
            ui.printBtn.style.display = 'block';
        }
        
        /**
         * Konwersja polskich znak√≥w do PC850
         */
        function convertPolishChars(text) {
            return text
                .replace(/ƒÖ/g, '\xA5')
                .replace(/ƒá/g, '\x86')
                .replace(/ƒô/g, '\xA9')
                .replace(/≈Ç/g, '\x9D')
                .replace(/≈Ñ/g, '\xE4')
                .replace(/√≥/g, '\xA2')
                .replace(/≈õ/g, '\x8C')
                .replace(/≈∫/g, '\x8F')
                .replace(/≈º/g, '\xAB')
                .replace(/ƒÑ/g, '\xA4')
                .replace(/ƒÜ/g, '\x8D')
                .replace(/ƒò/g, '\xA8')
                .replace(/≈Å/g, '\x9C')
                .replace(/≈É/g, '\xE3')
                .replace(/√ì/g, '\xE0')
                .replace(/≈ö/g, '\x8B')
                .replace(/≈π/g, '\x8E')
                .replace(/≈ª/g, '\xAA');
        }
        
        /**
         * Bezpieczne dzielenie tekstu
         */
        function wrapText(text, maxWidth) {
            if (!text || text.length <= maxWidth) return text;
            
            const words = text.split(' ');
            let lines = [];
            let currentLine = '';
            
            for (let word of words) {
                if (currentLine.length + word.length + 1 <= maxWidth) {
                    currentLine = currentLine ? currentLine + ' ' + word : word;
                } else {
                    if (currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        if (word.length > maxWidth) {
                            let i = 0;
                            while (i < word.length) {
                                let chunk = word.substring(i, Math.min(i + maxWidth, word.length));
                                lines.push(chunk);
                                i += maxWidth;
                            }
                        } else {
                            currentLine = word;
                        }
                    }
                }
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines.join('\n');
        }
        
        /**
         * Drukowanie paragonu
         */
        async function printReceipt() {
            if (!selectedAthlete) {
                alert('Nie wybrano zawodnika!');
                return false;
            }
            
            try {
                if (config.printer.type === 'usb' && config.printer.connected) {
                    // Drukowanie przez USB
                    const ESC = '\x1B';
                    const GS = '\x1D';
                    const PRINT_WIDTH = 48;
                    
                    let printData = '';
                    
                    // Inicjalizacja drukarki
                    printData += ESC + '@';
                    
                    // Ustaw kodowanie na PC850 (DOS Latin)
                    printData += ESC + 't' + '\x02';
                    
                    // Nag≈Ç√≥wek - wycentrowany i pogrubiony
                    printData += ESC + 'a' + '\x01'; // Centruj
                    printData += ESC + '!' + '\x10'; // Pogrubienie
                    printData += 'WYNIK BIEGU\n';
                    printData += ESC + '!' + '\x00'; // Normalny tekst
                    
                    // Nazwa biegu - zawiniƒôta
                    if (selectedAthlete.race_distance) {
                        const wrappedDistance = wrapText(convertPolishChars(selectedAthlete.race_distance), 30);
                        printData += wrappedDistance + '\n';
                    }
                    
                    printData += ESC + 'a' + '\x00'; // Wyr√≥wnaj do lewej
                    printData += '\n';
                    
                    // Numer startowy - pogrubiony
                    printData += ESC + '!' + '\x10';
                    printData += 'Numer: #' + (selectedAthlete.entry_bib || 'N/A') + '\n';
                    printData += ESC + '!' + '\x00';
                    
                    // Nazwisko
                    const name = `${selectedAthlete.athlete_first_name || ''} ${selectedAthlete.athlete_last_name || ''}`.trim();
                    printData += 'Zawodnik: ' + convertPolishChars(name) + '\n';

                    // Kategoria - wybierz najlepszƒÖ wed≈Çug priorytetu
                    const bestCategory = selectBestCategory(selectedAthlete);
                    if (bestCategory) {
                        printData += 'Kategoria: ' + convertPolishChars(bestCategory.name) + '\n';
                    } else if (selectedAthlete.bracket_name) {
                        printData += 'Kategoria: ' + convertPolishChars(selectedAthlete.bracket_name) + '\n';
                    }

                    printData += '\n';
                    
                    // Funkcja do formatowania linii z wyr√≥wnaniem do prawej
                    function formatLine(label, value) {
                        const paddingWidth = PRINT_WIDTH - label.length - value.length;
                        const padding = ' '.repeat(Math.max(0, paddingWidth));
                        return label + padding + value + '\n';
                    }
                    
                    // Czas netto - pogrubiony
                    const netTime = selectedAthlete.formatted_net_time || formatTime(selectedAthlete.net_time);
                    if (netTime && netTime !== '-') {
                        printData += ESC + '!' + '\x10';
                        printData += formatLine('Czas netto:', netTime);
                        printData += ESC + '!' + '\x00';
                    }
                    
                    // Czas brutto
                    const gunTime = selectedAthlete.formatted_gun_time || formatTime(selectedAthlete.gun_time);
                    if (gunTime && gunTime !== '-') {
                        printData += formatLine('Czas brutto:', gunTime);
                    }
                    
                    printData += '\n';
                    
                    // Miejsca
                    if (selectedAthlete.overall_place) {
                        printData += formatLine('Miejsce OPEN:', selectedAthlete.overall_place.toString());
                    }

                    if (selectedAthlete.gender_place) {
                        const genderLabel = selectedAthlete.athlete_sex === 'M' ? 'Miejsce mezczyzn:' : 'Miejsce kobiet:';
                        printData += formatLine(convertPolishChars(genderLabel), selectedAthlete.gender_place.toString());
                    }

                    // Miejsce w kategorii - u≈ºyj wybranej kategorii
                    if (bestCategory) {
                        printData += formatLine('Miejsce w kat.:', bestCategory.position.toString());
                    } else if (selectedAthlete.division_place) {
                        printData += formatLine('Miejsce w kat.:', selectedAthlete.division_place.toString());
                    }
                    
                    // W≈Çasna wiadomo≈õƒá
                    if (config.customMessages.custom) {
                        printData += '\n';
                        printData += ESC + 'a' + '\x01'; // Centruj
                        printData += convertPolishChars(config.customMessages.custom) + '\n';
                        printData += ESC + 'a' + '\x00'; // Wyr√≥wnaj do lewej
                    }
                    
                    // Stopka
                    printData += '\n';
                    printData += ESC + 'a' + '\x01'; // Centruj
                    printData += convertPolishChars(config.customMessages.footer);
                    
                    // Obetnij papier
                    printData += ESC + 'd' + '\x03';
                    printData += GS + 'V' + '\x01';
                    
                    // Wy≈õlij do drukarki
                    await sendToPrinter(printData);
                    
                    console.log('Wydruk wys≈Çany do drukarki USB');
                    return true;
                    
                } else {
                    // Drukowanie systemowe
                    window.print();
                    return true;
                }
                
            } catch (error) {
                console.error('B≈ÇƒÖd drukowania:', error);
                alert(`B≈ÇƒÖd drukowania: ${error.message}`);
                return false;
            }
        }
        
        /**
         * Przycisk drukowania
         */
        ui.printBtn.addEventListener('click', async () => {
            const success = await printReceipt();
            if (success) {
                // Wyczy≈õƒá wyszukiwanie po udanym wydruku
                setTimeout(() => {
                    ui.athleteSearchInput.value = '';
                    ui.receiptPreview.innerHTML = '<div class="status">Wyszukaj zawodnika, aby zobaczyƒá podglƒÖd</div>';
                    ui.printBtn.style.display = 'none';
                    selectedAthlete = null;
                }, 1000);
            }
        });
        
        // =====================================
        // Ustawienia - Zapisywanie
        // =====================================
        
        /**
         * Zapisywanie w≈Çasnych wiadomo≈õci
         */
        ui.customMessageInput.addEventListener('change', () => {
            config.customMessages.custom = ui.customMessageInput.value.trim();
            localStorage.setItem('custom-message', config.customMessages.custom);
        });
        
        ui.footerMessageInput.addEventListener('change', () => {
            config.customMessages.footer = ui.footerMessageInput.value.trim();
            localStorage.setItem('footer-message', config.customMessages.footer);
        });
        
        /**
         * Test drukowania
         */
        ui.testPrintBtn.addEventListener('click', async () => {
            try {
                setStatus('printer-connection-status', 'Drukowanie testu...', 'loading');
                
                const ESC = '\x1B';
                const GS = '\x1D';
                const PRINT_WIDTH = 48;
                
                let printData = '';
                
                // Inicjalizacja drukarki
                printData += ESC + '@';
                
                // Ustaw kodowanie na PC850
                printData += ESC + 't' + '\x02';
                
                // Nag≈Ç√≥wek testowy
                printData += ESC + 'a' + '\x01';
                printData += ESC + '!' + '\x10';
                printData += 'TEST DRUKARKI\n';
                printData += ESC + '!' + '\x00';
                printData += ESC + 'a' + '\x00';
                
                // Test polskich znak√≥w
                printData += '\nPolskie znaki:\n';
                const polishText = "Za≈º√≥≈Çƒá gƒô≈õlƒÖ ja≈∫≈Ñ ≈º√≥≈Çwiom";
                printData += convertPolishChars(polishText) + '\n\n';
                
                // Test d≈Çugiej nazwy
                printData += 'Test zawijania tekstu:\n';
                const longText = "Ultramaraton Narwia≈Ñski Trail Pogo≈Ñ za Bobrem 2025 Edycja IV";
                const wrappedText = wrapText(longText, 30);
                printData += convertPolishChars(wrappedText) + '\n\n';
                
                // Test wyr√≥wnania
                function formatLine(label, value) {
                    const paddingWidth = PRINT_WIDTH - label.length - value.length;
                    const padding = ' '.repeat(Math.max(0, paddingWidth));
                    return label + padding + value + '\n';
                }
                
                printData += formatLine("Czas netto:", "01:23:45");
                printData += formatLine("Miejsce OPEN:", "42");
                
                // Stopka
                printData += '\n';
                printData += ESC + 'a' + '\x01';
                printData += convertPolishChars(config.customMessages.footer);
                
                // Obetnij papier
                printData += ESC + 'd' + '\x03';
                printData += GS + 'V' + '\x01';
                
                // Wy≈õlij do drukarki
                await sendToPrinter(printData);
                
                setStatus('printer-connection-status', 'Test wydrukowany pomy≈õlnie', 'success');
                
            } catch (error) {
                console.error('B≈ÇƒÖd testu drukowania:', error);
                setStatus('printer-connection-status', `B≈ÇƒÖd: ${error.message}`, 'error');
            }
        });
        
        /**
         * Obs≈Çuga zmiany ID wydarzenia
         */
        ui.eventIdInput.addEventListener('change', () => {
            const eventId = ui.eventIdInput.value.trim();
            
            if (eventId) {
                config.api.eventId = eventId;
                localStorage.setItem('chronotrack-event-id', eventId);
                
                clearRefreshTimers();
                clearCache();
                initializeApi();
            }
        });
        
        // =====================================
        // Inicjalizacja
        // =====================================
        
        function init() {
            // Ustaw poczƒÖtkowe warto≈õci
            if (config.api.eventId) {
                ui.eventIdInput.value = config.api.eventId;
            }
            
            ui.customMessageInput.value = config.customMessages.custom;
            ui.footerMessageInput.value = config.customMessages.footer;
            ui.printerType.value = config.printer.type;
            
            // Inicjalizuj UI
            updatePrinterStatus();
            
            // Inicjalizuj API
            initializeApi();
            
            console.log('YO&GO Events Results Printer - inicjalizacja zako≈Ñczona (USB FIX v2.1)');
        }
        
        // NOWE: Cleanup przy zamykaniu strony
        window.addEventListener('beforeunload', () => {
            stopKeepAlive();
            
            if (config.printer.connected && config.printer.device) {
                if (config.printer.interface !== null) {
                    config.printer.device.releaseInterface(config.printer.interface).catch(console.error);
                }
                config.printer.device.close().catch(console.error);
            }
        });
        
        // Uruchom aplikacjƒô
        init();
    });
    </script>
</body>
</html>
